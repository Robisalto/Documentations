<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Pierre SABLE" />
  <meta name="dcterms.date" content="2021-07-16" />
  <title>POEI DevOps - Kubernetes</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="styleDark.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  
</head>
<body>
<header id="title-block-header">
<h1 class="title">POEI DevOps - Kubernetes</h1>
<p class="author">Pierre SABLE</p>
<p class="date">2021-07-16</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#doc-source">Doc Source</a>
<ul>
<li><a href="#gitlab">Gitlab</a></li>
<li><a href="#doc-officielle">Doc Officielle</a></li>
</ul></li>
<li><a href="#k8s-intro">K8S Intro</a>
<ul>
<li><a href="#philosophie-derri√®re-kubernetes-et-le-mouvement-cloud-native">Philosophie derri√®re Kubernetes et le mouvement ‚ÄúCloud Native‚Äù</a>
<ul>
<li><a href="#historique-et-popularit√©">Historique et popularit√©</a></li>
<li><a href="#le-cloud">Le Cloud</a></li>
<li><a href="#conteneurisation">Conteneurisation</a></li>
<li><a href="#le-mouvement-devops">Le mouvement DevOps</a></li>
<li><a href="#objectifs-du-devops">Objectifs du DevOps</a></li>
<li><a href="#apports-techniques-de-kubernetes-pour-le-devops">Apports techniques de Kubernetes pour le DevOps</a></li>
<li><a href="#architecture-logicielle-optimale-pour-kubernetes">Architecture logicielle optimale pour Kubernetes</a></li>
</ul></li>
</ul></li>
<li><a href="#maquette">Maquette</a>
<ul>
<li><a href="#d√©ploiement-de-la-maquette-k8s-binaire-kubectl">D√©ploiement de la maquette K8S + binaire kubectl</a>
<ul>
<li><a href="#installation-du-client-kubectl">Installation du client kubectl</a></li>
<li><a href="#installation-du-cluster-kubernetes">Installation du cluster Kubernetes</a></li>
<li><a href="#test-client-vers-cluster-k8s">Test CLIENT vers Cluster K8S :</a></li>
</ul></li>
<li><a href="#d√©marrage">D√©marrage</a></li>
</ul></li>
<li><a href="#tp-1">TP 1</a>
<ul>
<li><a href="#tp1cr√©ation-dun-pod">TP1:Cr√©ation d‚Äôun Pod</a>
<ul>
<li><a href="#cr√©ation-de-la-sp√©cification">1. Cr√©ation de la sp√©cification</a></li>
<li><a href="#lancement-du-pod">2. Lancement du Pod</a></li>
<li><a href="#v√©rification">3. V√©rification</a></li>
<li><a href="#details-du-pod">4. Details du Pod</a></li>
<li><a href="#acc√®s-√†-lapplication-via-un-port-forward">5. Acc√®s √† l‚Äôapplication via un port-forward</a></li>
<li><a href="#suppression-du-pod">6. Suppression du Pod</a></li>
</ul></li>
</ul></li>
<li><a href="#tp2">TP2</a>
<ul>
<li><a href="#tp2-cr√©ation-dun-pod-multi-conteneurs">TP2: Cr√©ation d‚Äôun Pod multi conteneurs</a>
<ul>
<li><a href="#cr√©ation-du-namespace-multi">1. Cr√©ation du namespace : multi</a></li>
<li><a href="#cr√©ation-de-la-sp√©cification-1">2. Cr√©ation de la sp√©cification</a></li>
<li><a href="#lancement-du-pod-1">3. Lancement du Pod</a></li>
<li><a href="#v√©rification-2">4. V√©rification</a></li>
<li><a href="#details-du-pod-1">5. Details du Pod</a></li>
<li><a href="#se-connecter-dans-le-conteneur-debian-du-pod-multipod">6. Se connecter dans le conteneur debian du pod multipod</a></li>
<li><a href="#suppression-du-pod-1">7. Suppression du Pod</a></li>
</ul></li>
<li><a href="#utilisation-volume-emptydir-et-conteneur-side-car">Utilisation volume emptyDir et conteneur side-car</a></li>
</ul></li>
<li><a href="#tp3">TP3</a>
<ul>
<li><a href="#cr√©ation-dun-service-nodeport">Cr√©ation d‚Äôun Service NodePort</a>
<ul>
<li><a href="#pr√©pa-suppression-des-ressources">Pr√©pa : suppression des ressources</a></li>
<li><a href="#ajout-de-label-dans-la-sp√©cification-multipod">1. Ajout de label dans la sp√©cification multipod</a></li>
<li><a href="#cr√©ation-de-la-sp√©cification-service">2. Cr√©ation de la sp√©cification Service</a></li>
<li><a href="#application-des-ressources">3. Application des ressources</a></li>
<li><a href="#acc√®s-au-service-depuis-lext√©rieur">4. Acc√®s au Service depuis l‚Äôext√©rieur</a></li>
<li><a href="#annexe">Annexe</a></li>
<li><a href="#fichier-yaml">Fichier YAML:</a></li>
</ul></li>
</ul></li>
<li><a href="#dashboard">Dashboard</a>
<ul>
<li><a href="#installation-du-dashboard">Installation du Dashboard</a></li>
</ul></li>
<li><a href="#tp4">TP4</a>
<ul>
<li><a href="#cr√©ation-dun-d√©ploiement">Cr√©ation d‚Äôun d√©ploiement</a>
<ul>
<li><a href="#pr√©pa-suppression-des-ressources-1">Pr√©pa : suppression des ressources</a></li>
<li><a href="#transformer-la-sp√©cification-multipod">1. Transformer la sp√©cification multipod</a></li>
<li><a href="#application-des-ressources-1">2. Application des ressources</a></li>
<li><a href="#r√©sultats">R√©sultats</a></li>
</ul></li>
</ul></li>
<li><a href="#tp5">TP5</a>
<ul>
<li><a href="#cr√©ation-dun-fichier-de-spec-backend">1. Cr√©ation d‚Äôun fichier de spec backend</a>
<ul>
<li><a href="#ressource-namespace">1.1 Ressource namespace</a></li>
<li><a href="#ressource-d√©ployment">1.2 Ressource D√©ployment</a></li>
<li><a href="#ressource-service-de-type-clusterip">1.3. Ressource service de type ClusterIP</a></li>
<li><a href="#application-des-ressources-2">1.4 Application des ressources</a></li>
<li><a href="#acc√®s-au-service-depuis-le-cluster">1.5. Acc√®s au Service depuis le cluster</a></li>
<li><a href="#utilisation-clusterip-port-forward-acc√®s-ext√©rieur-temporaire">1.6. Utilisation ClusterIP + port-forward =&gt; acc√®s ext√©rieur temporaire</a></li>
<li><a href="#visualisation-de-la-ressource-de-type-service">1.7. Visualisation de la ressource de type service</a></li>
<li><a href="#d√©tails-du-service">1.8. D√©tails du service</a></li>
</ul></li>
<li><a href="#cr√©ation-dun-fichier-de-spec-frontend">Cr√©ation d‚Äôun fichier de spec frontend</a></li>
<li><a href="#cr√©ation-dun-fichier-de-spec-backend-1">2. Cr√©ation d‚Äôun fichier de spec backend</a>
<ul>
<li><a href="#ressource-d√©ployment-1">2.1 Ressource D√©ployment</a></li>
<li><a href="#ressource-service-de-type-nodeport">2.2 Ressource service de type NodePort</a></li>
<li><a href="#application-des-ressources-3">2.3 Application des ressources</a></li>
<li><a href="#acc√®s-au-service-depuis-le-cluster-1">2.4 Acc√®s au Service depuis le cluster</a></li>
</ul></li>
</ul></li>
<li><a href="#tp-6">TP 6</a>
<ul>
<li><a href="#strat√©gie-rolling-update-et-rollback">Strat√©gie Rolling Update et rollback</a>
<ul>
<li><a href="#ajout-de-strat√©gie-de-rolling-update">1. Ajout de strat√©gie de rolling update</a></li>
<li><a href="#update-des-ressources-deployment">2. Update des ressources deployment</a></li>
</ul></li>
<li><a href="#v√©rification-de-lapplication-de-la-strat√©gie-dans-le-dashboard">3. V√©rification de l‚Äôapplication de la strat√©gie dans le dashboard</a></li>
<li><a href="#faire-un-scale-√†-10-r√©plicas-du-d√©ploiement-frontend">4. Faire un scale √† 10 r√©plicas du d√©ploiement frontend</a></li>
<li><a href="#r√©aliser-un-rolling-update-du-d√©ploiement-frontend">5. R√©aliser un rolling update du d√©ploiement frontend :</a></li>
</ul></li>
<li><a href="#documentation">Documentation</a>
<ul>
<li><a href="#client-kubectl">Client Kubectl</a></li>
<li><a href="#configuration-du-client">Configuration du client :</a></li>
<li><a href="#lister-les-ressources-k8s">Lister les ressources k8s</a></li>
<li><a href="#lister-les-ressources-cr√©√©es-dans-le-cluster">Lister les ressources cr√©√©es dans le cluster</a></li>
<li><a href="#documentation---aide">Documentation - aide</a></li>
<li><a href="#les-pods">LES PODS</a>
<ul>
<li><a href="#approche-imp√©rative">Approche imp√©rative</a></li>
<li><a href="#approche-d√©clarative">Approche d√©clarative</a></li>
</ul></li>
<li><a href="#mise-en-r√©seau---service">Mise en r√©seau - service</a></li>
<li><a href="#replicatset-et-deployments">ReplicatSet et Deployments</a></li>
<li><a href="#scaling-horizontal---mise-√†-l√©chelle">Scaling horizontal - Mise √† l‚Äô√©chelle</a></li>
<li><a href="#configmaps">ConfigMaps</a></li>
</ul></li>
<li><a href="#tips-tricks"><em>Tips &amp; Tricks</em></a>
<ul>
<li><a href="#cheatsheet">Cheatsheet</a></li>
</ul></li>
</ul>
</nav>
<link rel="icon" href="favicon.png" type="image/png" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<h4 id="kubernetes">Kubernetes</h4>
<p><strong>Pierre SABLE</strong> Formateur</p>
<p>D√©couvrez notre webTV : <a href="http://www.dawan.tv" class="uri">http://www.dawan.tv</a></p>
<h1 id="doc-source">Doc Source</h1>
<iframe src="2021-07-16-POEI-Kubernetes/Kubernetes.pdf" allowfullscreen>
</iframe>
<h2 id="gitlab">Gitlab</h2>
<p>Lien vers le GitLab de Pierre: <a href="https://gitlab.com/pierre.sable/poec_devops_kubernetes.git" class="uri">https://gitlab.com/pierre.sable/poec_devops_kubernetes.git</a></p>
<h2 id="doc-officielle">Doc Officielle</h2>
<ul>
<li><a href="https://kubernetes.io/fr/" class="uri">https://kubernetes.io/fr/</a></li>
</ul>
<h1 id="k8s-intro">K8S Intro</h1>
<h2 id="philosophie-derri√®re-kubernetes-et-le-mouvement-cloud-native">Philosophie derri√®re Kubernetes et le mouvement ‚ÄúCloud Native‚Äù</h2>
<h3 id="historique-et-popularit√©">Historique et popularit√©</h3>
<p>Kubernetes est un logiciel d√©velopp√© originellement par Google et bas√© sur une dizaine d‚Äôann√©es d‚Äôexp√©rience de d√©ploiement d‚Äôapplications √©normes (distribu√©es) sur des clusters de machines.</p>
<p>Dans la mythologie Cloud Native on raconte que son anc√™tre est l‚Äôorchestrateur borg utilis√© par Google dans les ann√©es 2000.</p>
<p>La premi√®re version est sortie en 2015 et k8s est devenu depuis l‚Äôun des projets open source les plus populaires du monde.</p>
<p>L‚Äô√©cosyst√®me logiciel de Kubernetes s‚Äôest d√©velopp√©e autour la Cloud Native Computing Foundation qui comprend notamment : Google, CoreOS, Mesosphere, Red Hat, Twitter, Huawei, Intel, Cisco, IBM, Docker, Univa et VMware. Cette fondation vise au pilotage et au financement collaboratif du d√©veloppement de Kubernetes (un peut comme la Linux Foundation). Trois transformations profondes de l‚Äôinformatique</p>
<p>Kubernetes se trouve au coeur de trois transformations profondes techniques, humaines et √©conomiques de l‚Äôinformatique:</p>
<ul>
<li>Le cloud</li>
<li>La conteneurisation logicielle</li>
<li>Le mouvement DevOps</li>
</ul>
<div class="info">
Il est un des projets qui symbolise et supporte techniquement ces transformations. D‚Äôo√π son omnipr√©sence dans les discussions informatiques actuellement.
</div>
<h3 id="le-cloud">Le Cloud</h3>
<p>Au del√† du flou dans l‚Äôemploi de ce terme, le cloud est un mouvement de r√©organisation technique et √©conomique de l‚Äôinformatique.</p>
<p>On retourne √† la consommation de <strong>‚Äútemps de calcul‚Äù</strong> et de services apr√®s une <strong>‚Äúaire du Personnal Computer‚Äù</strong>.</p>
<p>Pour organiser cela on d√©finit trois niveaux √† la fois techniques et √©conomiques de l‚Äôinformatique: - <strong>Software as a Service</strong>: location de services √† travers internet pour les usagers finaux - <strong>Plateforme as a Service</strong>: location d‚Äôun environnement d‚Äôex√©cution logiciel flexible √† destination des d√©veloppeurs - <strong>Infrastructure as a Service</strong>: location de resources ‚Äúmat√©rielles‚Äù √† la demande pour installer des logiciels sans avoir √† maintenir un data center.</p>
<h3 id="conteneurisation">Conteneurisation</h3>
<p>La conteneurisation est permise par l‚Äôisolation au niveau du noyau du syst√®me d‚Äôexploitation du serveur : les processus sont isol√©s dans des namespaces au niveau du noyau.</p>
<p>Cette innovation permet de simuler l‚Äôisolation sans ajouter une couche de virtualisation comme pour les machines virtuelles.</p>
<p>Ainsi les conteneurs permettent d‚Äôavoir des performances proche d‚Äôune application traditionnelle tournant directement sur le syst√®me d‚Äôexploitation hote et ainsi d‚Äôoptimiser les ressources.</p>
<p>Les images de conteneurs sont aussi beaucoup plus l√©gers qu‚Äôune image de VM</p>
<p>Les technologies de conteneurisation permettent donc de faire des bo√Ætes isol√©es avec les logiciels pour apporter l‚Äôuniformisation du d√©ploiement:</p>
<ul>
<li>Un fa√ßon standard de packager un logiciel (bas√©e sur le)</li>
<li>Cela permet d‚Äôassembler de grosses applications comme des legos</li>
<li>Cela r√©duit la complexit√© gr√¢ce:
<ul>
<li>√† l‚Äôint√©gration de toutes les d√©pendance d√©j√† dans la bo√Æte</li>
<li>au principe d‚Äôimmutabilit√© qui implique de jeter les bo√Ætes ( automatiser pour lutter contre la culture prudence).</li>
<li>Rend l‚Äôinfra pr√©dictible.</li>
</ul></li>
</ul>
<p>Les conteneurs sont souvent compar√©s √† l‚Äôinnovation du porte conteneur pour le transport de marchandise.</p>
<h3 id="le-mouvement-devops">Le mouvement DevOps</h3>
<ul>
<li>D√©passer l‚Äôopposition culturelle et de m√©tier entre les d√©veloppeurs et les administrateurs syst√®me.</li>
<li>Int√©grer tout le monde dans une seule √©quipe et ‚Ä¶</li>
<li>Calquer les rythmes de travail sur l‚Äôorganisation agile du d√©veloppement logiciel</li>
<li>Rapprocher techniquement la gestion de l‚Äôinfrastructure du d√©veloppement avec l‚Äôinfrastructure as code.
<ul>
<li>Concr√™tement on √©crit des fichiers de code pour g√©rer les √©l√©ments d‚Äôinfra</li>
<li>l‚Äô√©tat de l‚Äôinfrastructure est plus claire et document√©e par le code</li>
<li>la complexit√© est plus g√©rable car tout est d√©clar√© et modifiable au fur et √† mesure de fa√ßon centralis√©e</li>
<li>l‚Äôusage de git et des branches/tags pour la gestion de l‚Äô√©volution d‚Äôinfrastructure</li>
</ul></li>
</ul>
<h3 id="objectifs-du-devops">Objectifs du DevOps</h3>
<ul>
<li>Rapidit√© (velocity) de d√©ploiement logiciel (organisation agile du d√©veloppement et livraison jusqu‚Äô√† plusieurs fois par jour)
<ul>
<li>Implique l‚Äôautomatisation du d√©ploiement et ce qu‚Äôon appelle la CI/CD c‚Äôest √† dire une infrastructure de d√©ploiement continu √† partir de code.</li>
</ul></li>
<li>Passage √† l‚Äô√©chelle (horizontal scaling) des logiciels et des √©quipes de d√©veloppement (n√©cessaire pour les entreprises du cloud qui doivent servir pleins d‚Äôutilisateurs)</li>
<li>Meilleure organisation des √©quipes
<ul>
<li>meilleure compr√©hension globale du logiciel et de son installation de production car le savoir est mieux partag√©</li>
<li>organisation des √©quipes par th√©matique m√©tier plut√¥t que par sp√©cialit√© technique (l‚Äô√©quipe scale mieux)</li>
</ul></li>
</ul>
<h3 id="apports-techniques-de-kubernetes-pour-le-devops">Apports techniques de Kubernetes pour le DevOps</h3>
<ul>
<li>Abstraction et standardisation des infrastructures:</li>
<li>Langage descriptif et incr√©mental: on d√©crit ce qu‚Äôon veut plut√¥t que la logique complexe pour l‚Äôatteindre</li>
<li>Logique op√©rationnelle int√©gr√©e dans l‚Äôorchestrateur: la responsabilit√© des l‚Äô√©tat du cluster est laiss√© au controlleur k8s ce qui simplifie le travail</li>
</ul>
<p>On peut alors esp√©rer <strong>fluidifier</strong> la gestion des d√©fis techniques d‚Äôun grosse application et atteindre plus ou moins la livraison logicielle continue (CD de CI/CD)</p>
<h3 id="architecture-logicielle-optimale-pour-kubernetes">Architecture logicielle optimale pour Kubernetes</h3>
<p>Kubernetes est tr√®s versatile et permet d‚Äôinstaller des logiciels traditionnels ‚Äúmonolithiques‚Äù (gros backends situ√©s sur une seule machine).</p>
<p>Cependant aux vues des transformations humaines et techniques pr√©c√©dentes, l‚Äôorganisation de Kubernetes prend vraiment sens pour le d√©veloppement d‚Äôapplications microservices:</p>
<ul>
<li>des applications avec de nombreux de ‚Äúpetits‚Äù services.</li>
<li>chaque service a des probl√©matiques tr√®s limit√©es (gestion des factures = un logiciel qui fait que √ßa)</li>
<li>les services communiquent par le r√©seaux selon diff√©rents modes/API (REST, gRPC, job queues, GraphQL)</li>
</ul>
<p>Les microservices permettent justement le DevOps car:</p>
<ul>
<li>ils peuvent √™tre d√©ploy√©s s√©par√©ments</li>
<li>une petite √©quipe g√®re chaque service ou groupe th√©matique de services</li>
</ul>
<h1 id="maquette">Maquette</h1>
<h2 id="d√©ploiement-de-la-maquette-k8s-binaire-kubectl">D√©ploiement de la maquette K8S + binaire kubectl</h2>
<h3 id="installation-du-client-kubectl">Installation du client kubectl</h3>
<blockquote>
<p>N√©cessaire pour administrer, donner des ordres √† un(des) cluster(s) Kubernetes</p>
</blockquote>
<p>https://kubernetes.io/fr/docs/tasks/tools/install-kubectl/</p>
<h3 id="installation-du-cluster-kubernetes">Installation du cluster Kubernetes</h3>
<blockquote>
<p>On utilise un outils ‚Äúminikube‚Äù pour d√©ployer automatiquement un VM cluster K8S</p>
</blockquote>
<p>https://kubernetes.io/fr/docs/tasks/tools/install-minikube/</p>
<h3 id="test-client-vers-cluster-k8s">Test CLIENT vers Cluster K8S :</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a>$ <span class="ex">kubectl</span> cluster-info</span></code></pre></div>
<h5 id="mein-stuff">Mein Stuff üòÑ</h5>
<ul>
<li>Kubernetes: <a href="https://v1-18.docs.kubernetes.io/docs/tasks/tools/install-kubectl/" class="uri">https://v1-18.docs.kubernetes.io/docs/tasks/tools/install-kubectl/</a></li>
<li>Minikube: <a href="https://github.com/kubernetes/minikube/releases/download/v1.22.0/minikube-installer.exe" class="uri">https://github.com/kubernetes/minikube/releases/download/v1.22.0/minikube-installer.exe</a></li>
</ul>
<blockquote>
<p>minikube quickly sets up a local Kubernetes cluster on macOS, Linux, and Windows. We proudly focus on helping application developers and new Kubernetes users.</p>
</blockquote>
<h2 id="d√©marrage">D√©marrage</h2>
<p>On d√©marre avec la commande <code>minikube start</code>:</p>
<pre class="shell"><code>Admin stagiaire@BBG58Y2 MINGW64 ~/Kubernetes
$ minikube.exe start
ÔøΩ  minikube v1.22.0 sur Microsoft Windows 10 Pro 10.0.19041 Build 19041
‚ú®  Choix automatique du pilote virtualbox
ÔøΩ  T√©l√©chargement de l&#39;image de d√©marrage de la VM...
    &gt; minikube-v1.22.0.iso.sha256: 65 B / 65 B [-------------] 100.00% ? p/s 0s
    &gt; minikube-v1.22.0.iso: 46.90 KiB / 242.95 MiB [&gt;___________] 0.02% ? p    &gt; minikube-v1.22.0.iso: 94.89 KiB / 242.95 MiB [&gt;___________] 0.04% ? p    &gt; minikube-v1.22.0.iso: 174.89 KiB / 242.95 MiB [&gt;__________] 0.07% ? p
...</code></pre>
<p>Puis une fois tout install√©:</p>
<pre class="shell"><code>Admin stagiaire@BBG58Y2 MINGW64 ~/Kubernetes
$ minikube start
üòÑ  minikube v1.22.0 sur Microsoft Windows 10 Pro 10.0.19041 Build 19041
‚ú®  Utilisation du pilote virtualbox bas√© sur le profil existant
üëç  D√©marrage du noeud de plan de contr√¥le minikube dans le cluster minikube
üîÑ  Red√©marrage du virtualbox VM existant pour &quot;minikube&quot; ...
üê≥  Pr√©paration de Kubernetes v1.21.2 sur Docker 20.10.6...
    ‚ñ™ G√©n√©ration des certificats et des cl√©s
    ‚ñ™ D√©marrage du plan de contr√¥le ...
    ‚ñ™ Configuration des r√®gles RBAC ...
üîé  V√©rification des composants Kubernetes...
    ‚ñ™ Utilisation de l&#39;image gcr.io/k8s-minikube/storage-provisioner:v5
üåü  Modules activ√©s: storage-provisioner, default-storageclass

‚ùó  kubectl.exe est la version 1.18.17, qui peut comporter des incompatibilit√©s avec Kubernetes 1.21.2.
    ‚ñ™ Vous voulez kubectl v1.21.2 ? Essayez &#39;minikube kubectl -- get pods -A&#39;
üèÑ  Termin√© ! kubectl est maintenant configur√© pour utiliser &quot;minikube&quot; cluster et espace de noms &quot;default&quot; par d√©faut.
</code></pre>
<p>On v√©rifie en recherchant les infos du cluster:</p>
<pre class="shell"><code>Admin stagiaire@BBG58Y2 MINGW64 ~/Kubernetes
$ kubectl cluster-info
Kubernetes control plane is running at https://192.168.99.100:8443
CoreDNS is running at https://192.168.99.100:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.
</code></pre>
<h1 id="tp-1">TP 1</h1>
<h2 id="tp1cr√©ation-dun-pod">TP1:Cr√©ation d‚Äôun Pod</h2>
<p>Dans cet exercice, vous allez cr√©er une sp√©cification pour lancer un premier Pod.</p>
<h3 id="cr√©ation-de-la-sp√©cification">1. Cr√©ation de la sp√©cification</h3>
<p>Cr√©ez un fichier yaml <em>whoami.yaml</em> d√©finissant un Pod ayant les propri√©t√©s suivantes: - nom du Pod: <em>whoami</em> - image du container: <em>containous/whoami</em> - nom du container: <em>whoami</em></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Pod</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="at">  </span><span class="fu">creationTimestamp</span><span class="kw">:</span><span class="at"> </span><span class="ch">null</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="at">    </span><span class="fu">run</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> whoami</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="at">  </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">image</span><span class="kw">:</span><span class="at"> containous/whoami</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> whoami</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="at">    </span><span class="fu">resources</span><span class="kw">:</span><span class="at"> </span><span class="kw">{}</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="at">  </span><span class="fu">dnsPolicy</span><span class="kw">:</span><span class="at"> ClusterFirst</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="at">  </span><span class="fu">restartPolicy</span><span class="kw">:</span><span class="at"> Always</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="fu">status</span><span class="kw">:</span><span class="at"> </span><span class="kw">{}</span></span></code></pre></div>
<h3 id="lancement-du-pod">2. Lancement du Pod</h3>
<p>Lancez le Pod √† l‚Äôaide de <em>kubectl</em></p>
<p><code>kubectl apply -f whoami.yaml</code></p>
<h3 id="v√©rification">3. V√©rification</h3>
<p>Listez les Pods lanc√©s et assurez vous que le Pod <em>whoami</em> apparait bien dans cette liste.</p>
<pre class="shell"><code>$ kubectl get pods
NAME     READY   STATUS    RESTARTS   AGE
nginx    1/1     Running   0          37m
whoami   1/1     Running   0          81s</code></pre>
<h3 id="details-du-pod">4. Details du Pod</h3>
<p>Observez les d√©tails du Pod √† l‚Äôaide de <em>kubectl</em> et retrouvez l‚Äôinformation de l‚Äôimage utilis√©e par le container <em>whoami</em>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a>$ <span class="ex">kubectl</span> describe pod whoami</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="ex">Name</span>:         whoami</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="ex">Namespace</span>:    default</span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="ex">Priority</span>:     0</span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="ex">Node</span>:         minikube/192.168.99.100</span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="ex">Start</span> Time:   Fri, 16 Jul 2021 15:49:53 +0200</span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="ex">Labels</span>:       run=nginx</span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="ex">Annotations</span>:  <span class="op">&lt;</span>none<span class="op">&gt;</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="ex">Status</span>:       Running</span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="ex">IP</span>:           172.17.0.4</span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="ex">IPs</span>:</span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="ex">IP</span>:  172.17.0.4</span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="ex">Containers</span>:</span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="ex">whoami</span>:</span>
<span id="cb7-15"><a href="#cb7-15"></a>    <span class="ex">Container</span> ID:   docker://4497f232925a182598ddaddaa724b33729cc6230068a78951616c14b691fcd14</span>
<span id="cb7-16"><a href="#cb7-16"></a>    <span class="ex">Image</span>:          containous/whoami</span>
<span id="cb7-17"><a href="#cb7-17"></a>    <span class="ex">Image</span> ID:       docker-pullable://containous/whoami@sha256:7d6a3c8f91470a23ef380320609ee6e69ac68d20bc804f3a1c6065fb56cfa34e</span>
<span id="cb7-18"><a href="#cb7-18"></a>    <span class="ex">Port</span>:           <span class="op">&lt;</span>none<span class="op">&gt;</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>    <span class="ex">Host</span> Port:      <span class="op">&lt;</span>none<span class="op">&gt;</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>    <span class="ex">State</span>:          Running</span>
<span id="cb7-21"><a href="#cb7-21"></a>      <span class="ex">Started</span>:      Fri, 16 Jul 2021 15:50:01 +0200</span>
<span id="cb7-22"><a href="#cb7-22"></a>    <span class="ex">Ready</span>:          True</span>
<span id="cb7-23"><a href="#cb7-23"></a>    <span class="ex">Restart</span> Count:  0</span>
<span id="cb7-24"><a href="#cb7-24"></a>    <span class="ex">Environment</span>:    <span class="op">&lt;</span>none<span class="op">&gt;</span></span>
<span id="cb7-25"><a href="#cb7-25"></a>    <span class="ex">Mounts</span>:</span>
<span id="cb7-26"><a href="#cb7-26"></a>      <span class="ex">/var/run/secrets/kubernetes.io/serviceaccount</span> from kube-api-access-4p99m (ro)</span>
<span id="cb7-27"><a href="#cb7-27"></a><span class="ex">Conditions</span>:</span>
<span id="cb7-28"><a href="#cb7-28"></a>  <span class="ex">Type</span>              Status</span>
<span id="cb7-29"><a href="#cb7-29"></a>  <span class="ex">Initialized</span>       True</span>
<span id="cb7-30"><a href="#cb7-30"></a>  <span class="ex">Ready</span>             True</span>
<span id="cb7-31"><a href="#cb7-31"></a>  <span class="ex">ContainersReady</span>   True</span>
<span id="cb7-32"><a href="#cb7-32"></a>  <span class="ex">PodScheduled</span>      True</span>
<span id="cb7-33"><a href="#cb7-33"></a><span class="ex">Volumes</span>:</span>
<span id="cb7-34"><a href="#cb7-34"></a>  <span class="ex">kube-api-access-4p99m</span>:</span>
<span id="cb7-35"><a href="#cb7-35"></a>    <span class="ex">Type</span>:                    Projected (a volume that contains injected data from multiple sources)</span>
<span id="cb7-36"><a href="#cb7-36"></a>    <span class="ex">TokenExpirationSeconds</span>:  3607</span>
<span id="cb7-37"><a href="#cb7-37"></a>    <span class="ex">ConfigMapName</span>:           kube-root-ca.crt</span>
<span id="cb7-38"><a href="#cb7-38"></a>    <span class="ex">ConfigMapOptional</span>:       <span class="op">&lt;</span>nil<span class="op">&gt;</span></span>
<span id="cb7-39"><a href="#cb7-39"></a>    <span class="ex">DownwardAPI</span>:             true</span>
<span id="cb7-40"><a href="#cb7-40"></a><span class="ex">QoS</span> Class:                   BestEffort</span>
<span id="cb7-41"><a href="#cb7-41"></a><span class="ex">Node-Selectors</span>:              <span class="op">&lt;</span>none<span class="op">&gt;</span></span>
<span id="cb7-42"><a href="#cb7-42"></a><span class="ex">Tolerations</span>:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s</span>
<span id="cb7-43"><a href="#cb7-43"></a>                             <span class="ex">node.kubernetes.io</span>/unreachable:<span class="ex">NoExecute</span> op=Exists for 300s</span>
<span id="cb7-44"><a href="#cb7-44"></a><span class="ex">Events</span>:</span>
<span id="cb7-45"><a href="#cb7-45"></a>  <span class="ex">Type</span>    Reason     Age   From               Message</span>
<span id="cb7-46"><a href="#cb7-46"></a>  <span class="ex">----</span>    ------     ----  ----               -------</span>
<span id="cb7-47"><a href="#cb7-47"></a>  <span class="ex">Normal</span>  Scheduled  2m3s  default-scheduler  Successfully assigned default/whoami to minikube</span>
<span id="cb7-48"><a href="#cb7-48"></a>  <span class="ex">Normal</span>  Pulling    2m2s  kubelet            Pulling image <span class="st">&quot;containous/whoami&quot;</span></span>
<span id="cb7-49"><a href="#cb7-49"></a>  <span class="ex">Normal</span>  Pulled     115s  kubelet            Successfully pulled image <span class="st">&quot;containous/whoami&quot;</span> in 7.271245805s</span>
<span id="cb7-50"><a href="#cb7-50"></a>  <span class="ex">Normal</span>  Created    115s  kubelet            Created container whoami</span>
<span id="cb7-51"><a href="#cb7-51"></a>  <span class="ex">Normal</span>  Started    115s  kubelet            Started container whoami</span></code></pre></div>
<h3 id="acc√®s-√†-lapplication-via-un-port-forward">5. Acc√®s √† l‚Äôapplication via un port-forward</h3>
<p>Avec la commande <em>kubectl port-forward</em> envoyer une requ√™te √† l‚Äôapplication</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="ex">kubectl</span> port-forward whoami 8080:80</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="ex">Forwarding</span> from 127.0.0.1:8080 -<span class="op">&gt;</span> 80</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="ex">Forwarding</span> from [::1]:8080 -<span class="op">&gt;</span> 80</span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="ex">Handling</span> connection for 8080</span></code></pre></div>
<h3 id="suppression-du-pod">6. Suppression du Pod</h3>
<p>Supprimez le Pod.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a>$ <span class="ex">kubectl</span> delete pod whoami</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="ex">pod</span> <span class="st">&quot;whoami&quot;</span> deleted</span></code></pre></div>
<h1 id="tp2">TP2</h1>
<h2 id="tp2-cr√©ation-dun-pod-multi-conteneurs">TP2: Cr√©ation d‚Äôun Pod multi conteneurs</h2>
<p>Dans cet exercice, vous allez cr√©er un namespace d√©di√© et une une sp√©cification pour lancer un Pod avec deux conteneurs.</p>
<h3 id="cr√©ation-du-namespace-multi">1. Cr√©ation du namespace : multi</h3>
<p>Cr√©er un fichier de spec ‚Äúns_multi.yml‚Äù pour le namespace multi √† partir d‚Äôune commande imp√©rative:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1"></a><span class="pp">---</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Namespace</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multi</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multi</span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="co">...</span></span></code></pre></div>
<p>Appliquer le fichier de spec:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a>$ <span class="ex">kubectl</span> apply -f ns_multi.yml </span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="ex">namespace/multi</span> created</span></code></pre></div>
<h4 id="v√©rification-1">V√©rification</h4>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a>$ <span class="ex">kubectl</span> get namespace</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="ex">NAME</span>              STATUS   AGE</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="ex">default</span>           Active   119m</span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="ex">kube-node-lease</span>   Active   119m</span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="ex">kube-public</span>       Active   119m</span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="ex">kube-system</span>       Active   119m</span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="ex">multi</span>             Active   18m</span></code></pre></div>
<h4 id="correction-de-pierre">Correction de Pierre</h4>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a><span class="ex">kubectl</span> create namespace multi --dry-run=client <span class="op">&gt;</span> ns_multi.yaml</span></code></pre></div>
<h3 id="cr√©ation-de-la-sp√©cification-1">2. Cr√©ation de la sp√©cification</h3>
<p>Cr√©ez un fichier yaml <em>multipod.yaml</em> d√©finissant un Pod ayant les propri√©t√©s suivantes:</p>
<ul>
<li><p>nom du Pod: <em>mulitpod</em></p></li>
<li><p>namespace: <em>multi</em></p></li>
<li><p>image du container nginx: <em>nginx:1.18-alpine</em></p></li>
<li><p>nom du container: <em>nginx</em></p></li>
<li><p>image du container debian : <em>debian:buster-slim</em></p></li>
<li><p>nom du container: <em>debian</em></p></li>
<li><p>command: [‚Äúsleep‚Äù, ‚Äú600‚Äù]</p></li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb14-1"><a href="#cb14-1"></a><span class="pp">---</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Pod</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="at">  </span><span class="fu">creationTimestamp</span><span class="kw">:</span><span class="at"> </span><span class="ch">null</span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="at">    </span><span class="fu">run</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> mulitpod</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> multi</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="at">  </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">image</span><span class="kw">:</span><span class="at"> nginx:1.18-alpine</span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb14-14"><a href="#cb14-14"></a></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">image</span><span class="kw">:</span><span class="at"> debian:buster-slim</span></span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> debian</span></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;sleep&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;600&quot;</span><span class="kw">]</span></span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="co">...</span></span></code></pre></div>
<h3 id="lancement-du-pod-1">3. Lancement du Pod</h3>
<p>Lancez le Pod √† l‚Äôaide de <em>kubectl</em></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="ex">kubectl</span> apply -f multipod.yaml</span></code></pre></div>
<h3 id="v√©rification-2">4. V√©rification</h3>
<p>Listez les Pods lanc√©s et assurez vous que le Pod <em>multipod</em> apparait bien dans cette liste.</p>
<div class="warning">
Penser au namespace !!
</div>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1"></a>$  <span class="ex">kubectl</span> get pods --namespace=multi</span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="ex">NAME</span>       READY   STATUS    RESTARTS   AGE</span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="ex">mulitpod</span>   2/2     Running   0          6s</span></code></pre></div>
<h4 id="correction-pierre">Correction Pierre</h4>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a>$  <span class="ex">kubectl</span> get pods -n multi </span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="ex">NAME</span>       READY   STATUS    RESTARTS   AGE</span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="ex">mulitpod</span>   2/2     Running   1          12m</span></code></pre></div>
<h5 id="all-namespaces">All namespaces</h5>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a>$  <span class="ex">kubectl</span> get pods --all-namespaces</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="ex">NAMESPACE</span>     NAME                               READY   STATUS    RESTARTS   AGE</span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="ex">kube-system</span>   coredns-558bd4d5db-pr8h2           1/1     Running   0          125m</span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="ex">kube-system</span>   etcd-minikube                      1/1     Running   0          125m</span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="ex">kube-system</span>   kube-apiserver-minikube            1/1     Running   0          125m</span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="ex">kube-system</span>   kube-controller-manager-minikube   1/1     Running   0          125m</span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="ex">kube-system</span>   kube-proxy-npcdx                   1/1     Running   0          125m</span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="ex">kube-system</span>   kube-scheduler-minikube            1/1     Running   0          125m</span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="ex">kube-system</span>   storage-provisioner                1/1     Running   0          125m</span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="ex">multi</span>         mulitpod                           2/2     Running   1          13m</span></code></pre></div>
<h3 id="details-du-pod-1">5. Details du Pod</h3>
<p>Observez les d√©tails du Pod √† l‚Äôaide de <em>kubectl</em> et retrouvez l‚Äôinformation de l‚Äôimage utilis√©e par le container <em>multipod</em>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1"></a><span class="ex">kubectl</span> -n multi describe pod multipod </span></code></pre></div>
<h3 id="se-connecter-dans-le-conteneur-debian-du-pod-multipod">6. Se connecter dans le conteneur debian du pod multipod</h3>
<p>Avec la commande <em>kubectl exec -it</em> se connecter dans le conteneur debian Installer le package curl</p>
<p><code>apt update &amp;&amp; apt install curl</code></p>
<p>Tester une requete curl vers le service pod_ngin <code>curl http://localhost:80</code></p>
<h4 id="connexion-dans-le-conteneur">Connexion dans le conteneur</h4>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1"></a>$  <span class="ex">kubectl</span> -n multi exec -it multipod -c debian -- bash</span></code></pre></div>
<h4 id="update-test">Update &amp; Test</h4>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1"></a><span class="ex">apt</span> update</span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="ex">apt</span> install curl</span>
<span id="cb21-3"><a href="#cb21-3"></a></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="ex">curl</span> http://127.0.0.1:80</span></code></pre></div>
<h3 id="suppression-du-pod-1">7. Suppression du Pod</h3>
<p>Supprimez le Pod.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1"></a><span class="ex">kubectl</span> delete -f multipod.yaml</span></code></pre></div>
<h2 id="utilisation-volume-emptydir-et-conteneur-side-car">Utilisation volume emptyDir et conteneur side-car</h2>
<p>On souhaite utiliser un conteneur <strong>side-car</strong> <em>(ou satellite)</em> qui dispose de commandes pour t√©l√©charger du code source dans un volume de type <code>emptyDir</code> et ainsi le mettre √† dispo du conteneur applicatif nginx.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a>$ <span class="ex">kubectl</span> apply -f multipod.yaml</span>
<span id="cb23-2"><a href="#cb23-2"></a>$ <span class="ex">kubectl</span> get po -n multi</span>
<span id="cb23-3"><a href="#cb23-3"></a>$ <span class="ex">kubectl</span> port-forward -n multi multipod 8080:80</span></code></pre></div>
<h1 id="tp3">TP3</h1>
<h2 id="cr√©ation-dun-service-nodeport">Cr√©ation d‚Äôun Service NodePort</h2>
<p>Dans cet exercice, vous allez modifier le fichier de sp√©cification multipod.yaml afin d‚Äôajouter une ressource de type service NodePort</p>
<p>Le but est d‚Äôexposer de facon d√©finitive le port applicatif 80 sur le serveur nginx</p>
<h3 id="pr√©pa-suppression-des-ressources">Pr√©pa : suppression des ressources</h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1"></a>$ <span class="ex">kubectl</span> delete -f multipod</span></code></pre></div>
<h3 id="ajout-de-label-dans-la-sp√©cification-multipod">1. Ajout de label dans la sp√©cification multipod</h3>
<p>Dans le fichier <em>multipod.yaml</em>, ajouter un label afin de pouvoir par la suite associer d‚Äôautres ressources √† ce pod (service)</p>
<ul>
<li>label: <em>app: multipod</em></li>
</ul>
<h3 id="cr√©ation-de-la-sp√©cification-service">2. Cr√©ation de la sp√©cification Service</h3>
<p>Dans le fichier <em>multipod.yaml</em> d√©finissant ajouter une ressource de type service d√©finissant les caract√©ristiques suivantes : - nom du service: <em>multipod</em> - type: <em>NodePort</em> - un selector permettant le groupement des Pods ayant le label <em>app: multipod</em>. - exposition du port <em>80</em> √† l‚Äôint√©rieur du cluster - forward des requ√®tes vers le port <em>80</em> des Pods sous-jacents - exposition du port 31001 sur chacun des nodes du cluster (acc√®s depuis l‚Äôext√©rieur)</p>
<ul>
<li><p>Ex definition service NodePort</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> my-service</span></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb25-6"><a href="#cb25-6"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb25-7"><a href="#cb25-7"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> MyApp</span></span>
<span id="cb25-8"><a href="#cb25-8"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb25-9"><a href="#cb25-9"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb25-10"><a href="#cb25-10"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">protocol</span><span class="kw">:</span><span class="at"> TCP</span></span>
<span id="cb25-11"><a href="#cb25-11"></a><span class="at">      </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb25-12"><a href="#cb25-12"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb25-13"><a href="#cb25-13"></a><span class="at">      </span><span class="fu">nodePort</span><span class="kw">:</span><span class="at"> </span><span class="dv">31001</span></span></code></pre></div></li>
</ul>
<h3 id="application-des-ressources">3. Application des ressources</h3>
<p>Relancer l‚Äôapplication √† l‚Äôaide de <em>kubectl apply</em></p>
<p>V√©rifier la cr√©ation des ressources : <em>kubectl get</em></p>
<h3 id="acc√®s-au-service-depuis-lext√©rieur">4. Acc√®s au Service depuis l‚Äôext√©rieur</h3>
<p>Lancez un navigateur sur le port 31001 de l‚Äôune des machines du cluster.</p>
<p>Note: vous pouvez obtenir les adresses IP des nodes de votre cluster dans la colonne <em>INTERNAL-IP</em> du r√©sultat de la commande suivante:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1"></a>$ <span class="ex">kubectl</span> get nodes -o wide</span></code></pre></div>
<h3 id="annexe">Annexe</h3>
<div class="warning">
Attention au namespace
</div>
<div class="info">
<p><code>kubectl api-ressource</code> pour lister les ressources, leur nom et raccourcis nom.</p>
<code>kubectl delete {ressource} {nom_ressource}</code> si besoin ;)
</div>
<ul>
<li>Lister les ressources du namespace multi :</li>
</ul>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1"></a>$ <span class="ex">kubectl</span> get -n multi all</span>
<span id="cb27-2"><a href="#cb27-2"></a>$ <span class="ex">kubectl</span> get -n multi pod,service</span></code></pre></div>
<h3 id="fichier-yaml">Fichier YAML:</h3>
<p>Ci-dessous le r√©sultat dans le fichier <code>multipod.yaml</code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb28-1"><a href="#cb28-1"></a><span class="pp">---</span></span>
<span id="cb28-2"><a href="#cb28-2"></a></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Namespace</span></span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multi</span></span>
<span id="cb28-7"><a href="#cb28-7"></a></span>
<span id="cb28-8"><a href="#cb28-8"></a><span class="pp">---</span></span>
<span id="cb28-9"><a href="#cb28-9"></a></span>
<span id="cb28-10"><a href="#cb28-10"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb28-11"><a href="#cb28-11"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Pod</span></span>
<span id="cb28-12"><a href="#cb28-12"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb28-13"><a href="#cb28-13"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multipod</span></span>
<span id="cb28-14"><a href="#cb28-14"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> multi</span></span>
<span id="cb28-15"><a href="#cb28-15"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb28-16"><a href="#cb28-16"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> multipod</span></span>
<span id="cb28-17"><a href="#cb28-17"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb28-18"><a href="#cb28-18"></a><span class="at">  </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb28-19"><a href="#cb28-19"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb28-20"><a href="#cb28-20"></a><span class="at">      </span><span class="fu">image</span><span class="kw">:</span><span class="at"> nginx:1.18-alpine</span></span>
<span id="cb28-21"><a href="#cb28-21"></a><span class="at">      </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb28-22"><a href="#cb28-22"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multipod-partage</span></span>
<span id="cb28-23"><a href="#cb28-23"></a><span class="at">          </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /usr/share/nginx/html</span></span>
<span id="cb28-24"><a href="#cb28-24"></a><span class="at">  </span><span class="fu">initContainers</span><span class="kw">:</span></span>
<span id="cb28-25"><a href="#cb28-25"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> alpine</span></span>
<span id="cb28-26"><a href="#cb28-26"></a><span class="at">      </span><span class="fu">image</span><span class="kw">:</span><span class="at"> alpine:3.12</span></span>
<span id="cb28-27"><a href="#cb28-27"></a><span class="at">      </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;/bin/sh&quot;</span><span class="kw">]</span></span>
<span id="cb28-28"><a href="#cb28-28"></a><span class="at">      </span><span class="fu">args</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;-c&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;wget https://raw.githubusercontent.com/psable/k8s_html/master/index.html -P /partage/&quot;</span><span class="kw">]</span></span>
<span id="cb28-29"><a href="#cb28-29"></a><span class="at">      </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb28-30"><a href="#cb28-30"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multipod-partage</span></span>
<span id="cb28-31"><a href="#cb28-31"></a><span class="at">          </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /partage</span></span>
<span id="cb28-32"><a href="#cb28-32"></a><span class="at">  </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb28-33"><a href="#cb28-33"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multipod-partage</span></span>
<span id="cb28-34"><a href="#cb28-34"></a><span class="at">      </span><span class="fu">emptyDir</span><span class="kw">:</span><span class="at"> </span><span class="kw">{}</span></span>
<span id="cb28-35"><a href="#cb28-35"></a></span>
<span id="cb28-36"><a href="#cb28-36"></a></span>
<span id="cb28-37"><a href="#cb28-37"></a><span class="pp">---</span></span>
<span id="cb28-38"><a href="#cb28-38"></a></span>
<span id="cb28-39"><a href="#cb28-39"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb28-40"><a href="#cb28-40"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb28-41"><a href="#cb28-41"></a><span class="fu">metadata</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb28-42"><a href="#cb28-42"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multipod</span></span>
<span id="cb28-43"><a href="#cb28-43"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> multi</span></span>
<span id="cb28-44"><a href="#cb28-44"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb28-45"><a href="#cb28-45"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb28-46"><a href="#cb28-46"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> multipod</span></span>
<span id="cb28-47"><a href="#cb28-47"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb28-48"><a href="#cb28-48"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb28-49"><a href="#cb28-49"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb28-50"><a href="#cb28-50"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb28-51"><a href="#cb28-51"></a><span class="at">      </span><span class="fu">nodePort</span><span class="kw">:</span><span class="at"> </span><span class="dv">31001</span></span>
<span id="cb28-52"><a href="#cb28-52"></a><span class="at">      </span><span class="fu">protocol</span><span class="kw">:</span><span class="at"> TCP</span></span>
<span id="cb28-53"><a href="#cb28-53"></a></span>
<span id="cb28-54"><a href="#cb28-54"></a></span>
<span id="cb28-55"><a href="#cb28-55"></a></span>
<span id="cb28-56"><a href="#cb28-56"></a><span class="co">...</span></span></code></pre></div>
<h4 id="v√©rification-3">V√©rification</h4>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1"></a><span class="ex">Admin</span> stagiaire@BBG58Y2 MINGW64 ~/Kubernetes</span>
<span id="cb29-2"><a href="#cb29-2"></a>$ <span class="ex">kubectl.exe</span> get all -n multi</span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="ex">NAME</span>           READY   STATUS    RESTARTS   AGE</span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="ex">pod/multipod</span>   1/1     Running   0          4m59s</span>
<span id="cb29-5"><a href="#cb29-5"></a></span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="ex">NAME</span>               TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        <span class="ex">AGE</span></span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="ex">service/multipod</span>   NodePort   10.99.48.217   <span class="op">&lt;</span>none<span class="op">&gt;</span>        80:31001/TCP   4m59s</span>
<span id="cb29-8"><a href="#cb29-8"></a></span>
<span id="cb29-9"><a href="#cb29-9"></a><span class="ex">Admin</span> stagiaire@BBG58Y2 MINGW64 ~/Kubernetes</span>
<span id="cb29-10"><a href="#cb29-10"></a>$ <span class="ex">kubectl.exe</span> get nodes -o wide</span>
<span id="cb29-11"><a href="#cb29-11"></a><span class="ex">NAME</span>       STATUS   ROLES                  AGE     VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE               KERNEL-VERSION   CONTAINER-RUNTIME</span>
<span id="cb29-12"><a href="#cb29-12"></a><span class="ex">minikube</span>   Ready    control-plane,master   2d23h   v1.21.2   192.168.99.100   <span class="op">&lt;</span>none<span class="op">&gt;</span>        Buildroot 2020.02.12   4.19.182         docker://20.10.6</span></code></pre></div>
<h5 id="page-web">Page web</h5>
<p><img src="2021-07-16-POEI-Kubernetes/2021-07-19_14h12_08.png" /></p>
<h1 id="dashboard">Dashboard</h1>
<p>Documentation officielle du <a href="https://kubernetes.io/fr/docs/tasks/access-application-cluster/web-ui-dashboard/">Tableau de bord (Dashboard)</a></p>
<h2 id="installation-du-dashboard">Installation du Dashboard</h2>
<p>On intalle le tableau de bord avec:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1"></a><span class="ex">kubectl</span> apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended.yaml</span></code></pre></div>
<h1 id="tp4">TP4</h1>
<h2 id="cr√©ation-dun-d√©ploiement">Cr√©ation d‚Äôun d√©ploiement</h2>
<p>Dans cet exercice, vous allez modifier le fichier de sp√©cification multipod.yaml afin de transformer le simple en un deployment (+ replicaset + pod)</p>
<h3 id="pr√©pa-suppression-des-ressources-1">Pr√©pa : suppression des ressources</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1"></a>$ <span class="ex">kubectl</span> delete -f multipod</span></code></pre></div>
<h3 id="transformer-la-sp√©cification-multipod">1. Transformer la sp√©cification multipod</h3>
<p>Ex :</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb32-1"><a href="#cb32-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx-deployment</span></span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">3</span></span>
<span id="cb32-9"><a href="#cb32-9"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb32-10"><a href="#cb32-10"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb32-11"><a href="#cb32-11"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb32-12"><a href="#cb32-12"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb32-13"><a href="#cb32-13"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb32-14"><a href="#cb32-14"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb32-15"><a href="#cb32-15"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb32-16"><a href="#cb32-16"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb32-17"><a href="#cb32-17"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb32-18"><a href="#cb32-18"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb32-19"><a href="#cb32-19"></a><span class="at">        </span><span class="fu">image</span><span class="kw">:</span><span class="at"> nginx:1.7.9</span></span>
<span id="cb32-20"><a href="#cb32-20"></a><span class="at">        </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb32-21"><a href="#cb32-21"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">containerPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span></code></pre></div>
<h3 id="application-des-ressources-1">2. Application des ressources</h3>
<p>Relancer l‚Äôapplication √† l‚Äôaide de <em>kubectl apply</em></p>
<p>V√©rifier la cr√©ation des ressources : <em>kubectl get</em></p>
<h3 id="r√©sultats">R√©sultats</h3>
<h4 id="fichier-yaml-1">Fichier YAML</h4>
<p>Contenu du fichier <code>multipod.yaml</code>:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb33-1"><a href="#cb33-1"></a><span class="pp">---</span></span>
<span id="cb33-2"><a href="#cb33-2"></a></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Namespace</span></span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multi</span></span>
<span id="cb33-7"><a href="#cb33-7"></a></span>
<span id="cb33-8"><a href="#cb33-8"></a><span class="pp">---</span></span>
<span id="cb33-9"><a href="#cb33-9"></a></span>
<span id="cb33-10"><a href="#cb33-10"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> apps/v1</span></span>
<span id="cb33-11"><a href="#cb33-11"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Deployment</span></span>
<span id="cb33-12"><a href="#cb33-12"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb33-13"><a href="#cb33-13"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multipod</span></span>
<span id="cb33-14"><a href="#cb33-14"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> multi</span></span>
<span id="cb33-15"><a href="#cb33-15"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb33-16"><a href="#cb33-16"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> multipod</span></span>
<span id="cb33-17"><a href="#cb33-17"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb33-18"><a href="#cb33-18"></a><span class="at">  </span><span class="fu">replicas</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb33-19"><a href="#cb33-19"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb33-20"><a href="#cb33-20"></a><span class="at">    </span><span class="fu">matchLabels</span><span class="kw">:</span></span>
<span id="cb33-21"><a href="#cb33-21"></a><span class="at">      </span><span class="fu">app</span><span class="kw">:</span><span class="at"> multipod</span></span>
<span id="cb33-22"><a href="#cb33-22"></a><span class="at">  </span><span class="fu">template</span><span class="kw">:</span></span>
<span id="cb33-23"><a href="#cb33-23"></a><span class="at">    </span><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb33-24"><a href="#cb33-24"></a><span class="at">      </span><span class="fu">labels</span><span class="kw">:</span></span>
<span id="cb33-25"><a href="#cb33-25"></a><span class="at">        </span><span class="fu">app</span><span class="kw">:</span><span class="at"> multipod</span></span>
<span id="cb33-26"><a href="#cb33-26"></a></span>
<span id="cb33-27"><a href="#cb33-27"></a><span class="at">    </span><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb33-28"><a href="#cb33-28"></a><span class="at">      </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb33-29"><a href="#cb33-29"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> nginx</span></span>
<span id="cb33-30"><a href="#cb33-30"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> nginx:1.18-alpine</span></span>
<span id="cb33-31"><a href="#cb33-31"></a><span class="at">          </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb33-32"><a href="#cb33-32"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multipod-partage</span></span>
<span id="cb33-33"><a href="#cb33-33"></a><span class="at">              </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /usr/share/nginx/html</span></span>
<span id="cb33-34"><a href="#cb33-34"></a><span class="at">      </span><span class="fu">initContainers</span><span class="kw">:</span></span>
<span id="cb33-35"><a href="#cb33-35"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> alpine</span></span>
<span id="cb33-36"><a href="#cb33-36"></a><span class="at">          </span><span class="fu">image</span><span class="kw">:</span><span class="at"> alpine:3.12</span></span>
<span id="cb33-37"><a href="#cb33-37"></a><span class="at">          </span><span class="fu">command</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;/bin/sh&quot;</span><span class="kw">]</span></span>
<span id="cb33-38"><a href="#cb33-38"></a><span class="at">          </span><span class="fu">args</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;-c&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;wget https://raw.githubusercontent.com/psable/k8s_html/master/index.html -P /partage/&quot;</span><span class="kw">]</span></span>
<span id="cb33-39"><a href="#cb33-39"></a><span class="at">          </span><span class="fu">volumeMounts</span><span class="kw">:</span></span>
<span id="cb33-40"><a href="#cb33-40"></a><span class="at">            </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multipod-partage</span></span>
<span id="cb33-41"><a href="#cb33-41"></a><span class="at">              </span><span class="fu">mountPath</span><span class="kw">:</span><span class="at"> /partage</span></span>
<span id="cb33-42"><a href="#cb33-42"></a><span class="at">      </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb33-43"><a href="#cb33-43"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multipod-partage</span></span>
<span id="cb33-44"><a href="#cb33-44"></a><span class="at">          </span><span class="fu">emptyDir</span><span class="kw">:</span><span class="at"> </span><span class="kw">{}</span></span>
<span id="cb33-45"><a href="#cb33-45"></a></span>
<span id="cb33-46"><a href="#cb33-46"></a></span>
<span id="cb33-47"><a href="#cb33-47"></a><span class="pp">---</span></span>
<span id="cb33-48"><a href="#cb33-48"></a></span>
<span id="cb33-49"><a href="#cb33-49"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb33-50"><a href="#cb33-50"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Service</span></span>
<span id="cb33-51"><a href="#cb33-51"></a><span class="fu">metadata</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb33-52"><a href="#cb33-52"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> multipod</span></span>
<span id="cb33-53"><a href="#cb33-53"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> multi</span></span>
<span id="cb33-54"><a href="#cb33-54"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb33-55"><a href="#cb33-55"></a><span class="at">  </span><span class="fu">selector</span><span class="kw">:</span></span>
<span id="cb33-56"><a href="#cb33-56"></a><span class="at">    </span><span class="fu">app</span><span class="kw">:</span><span class="at"> multipod</span></span>
<span id="cb33-57"><a href="#cb33-57"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> NodePort</span></span>
<span id="cb33-58"><a href="#cb33-58"></a><span class="at">  </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb33-59"><a href="#cb33-59"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">port</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb33-60"><a href="#cb33-60"></a><span class="at">      </span><span class="fu">targetPort</span><span class="kw">:</span><span class="at"> </span><span class="dv">80</span></span>
<span id="cb33-61"><a href="#cb33-61"></a><span class="at">      </span><span class="fu">nodePort</span><span class="kw">:</span><span class="at"> </span><span class="dv">31001</span></span>
<span id="cb33-62"><a href="#cb33-62"></a><span class="at">      </span><span class="fu">protocol</span><span class="kw">:</span><span class="at"> TCP</span></span>
<span id="cb33-63"><a href="#cb33-63"></a></span>
<span id="cb33-64"><a href="#cb33-64"></a></span>
<span id="cb33-65"><a href="#cb33-65"></a><span class="co">...</span></span></code></pre></div>
<h5 id="cr√©ation-du-deployment">Cr√©ation du Deployment</h5>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1"></a>$ <span class="ex">kubectl.exe</span> apply -f multipod.yaml</span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="ex">namespace/multi</span> unchanged</span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="ex">deployment.apps/multipod</span> created</span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="ex">service/multipod</span> unchanged</span></code></pre></div>
<h5 id="v√©rification-4">V√©rification</h5>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1"></a>$ <span class="ex">kubectl.exe</span> get deployments -n multi</span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="ex">NAME</span>       READY   UP-TO-DATE   AVAILABLE   AGE</span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="ex">multipod</span>   1/1     1            1           24s</span></code></pre></div>
<h1 id="tp5">TP5</h1>
<p>Dans cet exercice, vous allez cr√©er un Deployment et l‚Äôexposer √† l‚Äôint√©rieur du cluster en utilisant un Service de type <em>ClusterIP</em>.</p>
<p>Sch√©ma:</p>
<p><img src="2021-07-16-POEI-Kubernetes/Diagramme_TP5.png" /></p>
<h2 id="cr√©ation-dun-fichier-de-spec-backend">1. Cr√©ation d‚Äôun fichier de spec backend</h2>
<ul>
<li>Cr√©er un fichier de spec : myphp_backend.yaml</li>
</ul>
<h3 id="ressource-namespace">1.1 Ressource namespace</h3>
<p>Cr√©er un ressource de type namespace avec le sp√©cificit√©s suivantes :</p>
<ul>
<li>name: myphp</li>
<li>labels:
<ul>
<li>projet: myphp</li>
</ul></li>
</ul>
<h3 id="ressource-d√©ployment">1.2 Ressource D√©ployment</h3>
<p>Cr√©ez d√©finissant un Deployment ayant les propri√©t√©s suivantes:</p>
<ul>
<li>nom: <em>backend-deploy</em></li>
<li>label associ√© au Pod: <em>app: myphp_backend</em> (ce label est √† sp√©cifier dans les metadatas du Pod)</li>
<li>replica : 2</li>
<li>nom du container: <em>backend</em></li>
<li>labels
<ul>
<li><em>app: myphp_backend</em></li>
<li><em>projet: myphp</em></li>
</ul></li>
<li>namespace : myphp</li>
<li>image du container: <em>bilbloke/backend:1.0</em></li>
</ul>
<h3 id="ressource-service-de-type-clusterip">1.3. Ressource service de type ClusterIP</h3>
<p>Cr√©ez une ressource d√©finissant un service ayant les caract√©ristiques suivantes: - nom: <em>backend</em> - label: - <em>app: myphp_backend</em> - <em>projet: myphp</em> - namespace : myphp - type: <em>ClusterIP</em> - un selector permettant le groupement des Pods ayant le label <em>app: myphp_backend</em>. - exposition du port <em>80</em> dans le cluster - forward des requ√®tes vers le port <em>80</em> des Pods sous-jacents</p>
<h3 id="application-des-ressources-2">1.4 Application des ressources</h3>
<p>La commande suivante permet de cr√©er le deployment</p>
<pre><code>$ kubectl apply -f myphp_backend.yaml</code></pre>
<h3 id="acc√®s-au-service-depuis-le-cluster">1.5. Acc√®s au Service depuis le cluster</h3>
<ul>
<li>Cr√©er un fichier <em>client_pod.yaml</em> d√©finissant le Pod dont la sp√©cification est la suivante:</li>
</ul>
<div class="sourceCode" id="cb37"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb37-1"><a href="#cb37-1"></a><span class="fu">apiVersion</span><span class="kw">:</span><span class="at"> v1</span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="fu">kind</span><span class="kw">:</span><span class="at"> Pod</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="fu">metadata</span><span class="kw">:</span></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> debug</span></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="at">  </span><span class="fu">namespace</span><span class="kw">:</span><span class="at"> myphp</span></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="at">  </span><span class="fu">labels</span><span class="kw">:</span><span class="at"> </span></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="at">    </span><span class="fu">projet</span><span class="kw">:</span><span class="at"> myphp</span></span>
<span id="cb37-8"><a href="#cb37-8"></a><span class="fu">spec</span><span class="kw">:</span></span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="at">  </span><span class="fu">containers</span><span class="kw">:</span></span>
<span id="cb37-10"><a href="#cb37-10"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> debug</span></span>
<span id="cb37-11"><a href="#cb37-11"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> alpine:3.9</span></span>
<span id="cb37-12"><a href="#cb37-12"></a><span class="at">    </span><span class="fu">command</span><span class="kw">:</span></span>
<span id="cb37-13"><a href="#cb37-13"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;sleep&quot;</span></span>
<span id="cb37-14"><a href="#cb37-14"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;10000&quot;</span></span></code></pre></div>
<p>Nous allons utiliser ce Pod pour acc√®der au Service <em>backend</em> depuis l‚Äôint√©rieur du cluster. Ce Pod contient un seul container, bas√© sur alpine et qui est lanc√© avec la commande <code>sleep 10000</code>. Ce container sera donc en attente pendant 10000 secondes. Nous pourrons alors lancer un shell int√©ractif √† l‚Äôint√©rieur de celui-ci et tester la communication avec le Service <em>backend</em>.</p>
<ul>
<li>Lancez le Pod avec <em>kubectl</em>.</li>
</ul>
<p><code>kubectl apply -f client_pod.yaml</code></p>
<ul>
<li>Lancez un shell int√©ractif <em>sh</em> dans le container <em>debug</em> du Pod.</li>
</ul>
<p><code>kubectl exec -it debug -n myphp -- sh</code></p>
<ul>
<li>Installer l‚Äôutilitaire <em>curl</em></li>
</ul>
<p>le container <em>debug</em> du Pod du m√™me nom est bas√© sur l‚Äôimage <em>alpine:3.9</em> qui ne contient pas l‚Äôutilitaire <em>curl</em> par d√©faut. Il faut donc l‚Äôinstaller avec la commande suivante:</p>
<pre><code>/ # apk update &amp;&amp; apk add curl</code></pre>
<ul>
<li>Utilisez <em>curl</em> pour envoyer une requ√™te HTTP Get sur le port <em>80</em> du service <em>myphp_backend</em>. Vous devriez obtenir le contenu, sous forme textuel, de la page <em>index.php</em> servie par d√©faut par <em>myphp_backend</em>.</li>
</ul>
<pre><code>curl http://backend/index.php</code></pre>
<p>Ceci montre que depuis le cluster, si l‚Äôon acc√®de au Service <em>backend</em> la requ√™te est bien envoy√©e √† l‚Äôun des Pods (nous en avons cr√©√© un seul ici) regroup√© par le Service (via la cl√© <em>selector</em>).</p>
<h3 id="utilisation-clusterip-port-forward-acc√®s-ext√©rieur-temporaire">1.6. Utilisation ClusterIP + port-forward =&gt; acc√®s ext√©rieur temporaire</h3>
<p>Acc√®der au service backend depuis l‚Äôext√©rieur temporairement √† l‚Äôaide de port-forward :</p>
<p><code>kubectl port-forward -n myphp svc/backend 8080:80</code></p>
<h3 id="visualisation-de-la-ressource-de-type-service">1.7. Visualisation de la ressource de type service</h3>
<p>A l‚Äôaide de <code>kubectl get</code>, visualisez la <em>sp√©cification</em> du service <em>backend</em>.</p>
<pre><code>kubectl get service backend
kubectl get service backend -o yaml</code></pre>
<h3 id="d√©tails-du-service">1.8. D√©tails du service</h3>
<p>A l‚Äôaide de <em>kubectl describe</em>, listez les d√©tails du service <em>backend</em></p>
<p>Notez l‚Äôexistence d‚Äôune entr√©e dans <em>Endpoints</em>, celle-ci correspond √† l‚ÄôIP du Pod qui est utilis√© par le Service.</p>
<p>Note: si plusieurs Pods avaient le label <em>app: backend</em>, il y aurait une entr√©e Endpoint pour chacun d‚Äôentre eux.</p>
<p><code>kubectl describe service backend</code></p>
<h2 id="cr√©ation-dun-fichier-de-spec-frontend">Cr√©ation d‚Äôun fichier de spec frontend</h2>
<h2 id="cr√©ation-dun-fichier-de-spec-backend-1">2. Cr√©ation d‚Äôun fichier de spec backend</h2>
<ul>
<li>Cr√©er un fichier de spec : myphp_frontend.yaml</li>
</ul>
<h3 id="ressource-d√©ployment-1">2.1 Ressource D√©ployment</h3>
<p>Cr√©ez d√©finissant un Deployment ayant les propri√©t√©s suivantes:</p>
<ul>
<li>nom: <em>frontend-deploy</em></li>
<li>label associ√© au Pod: <em>app: myphp_frontend</em> (ce label est √† sp√©cifier dans les metadatas du Pod)</li>
<li>replica : 2</li>
<li>nom du container: <em>frontend</em></li>
<li>labels
<ul>
<li><em>app: myphp_frontend</em></li>
<li><em>projet: myphp</em></li>
</ul></li>
<li>namespace : myphp</li>
<li>image du container: <em>bilbloke/frontend:1.0</em></li>
</ul>
<h3 id="ressource-service-de-type-nodeport">2.2 Ressource service de type NodePort</h3>
<p>Cr√©ez une ressource d√©finissant un service ayant les caract√©ristiques suivantes: - nom: <em>myphp_frontend</em> - label: - <em>app: myphp-frontend</em> - <em>projet: myphp</em> - namespace : myphp - type: <em>NodePort</em> - un selector permettant le groupement des Pods ayant le label <em>app: myphp_frontend</em>. - exposition du port <em>80</em> dans le cluster - forward des requ√®tes vers le port <em>80</em> des Pods sous-jacents - NodePort: 31500</p>
<h3 id="application-des-ressources-3">2.3 Application des ressources</h3>
<p>La commande suivante permet de cr√©er le deployment</p>
<pre><code>$ kubectl apply -f myphp_frontend.yaml</code></pre>
<h3 id="acc√®s-au-service-depuis-le-cluster-1">2.4 Acc√®s au Service depuis le cluster</h3>
<p>Acc√®der √† l‚Äôappli depuis un navigateur : http://IP_INTERNAL:31500/index.php</p>
<h1 id="tp-6">TP 6</h1>
<h2 id="strat√©gie-rolling-update-et-rollback">Strat√©gie Rolling Update et rollback</h2>
<p>Dans cet exercice, vous allez modifier les fichiers de sp√©cification myphp_frontend.yaml et myphp_backend.yaml afin de configurer la strat√©gie de rolling update (0 downtime)</p>
<p>Le but est de r√©aliser une mise √† jour des images en 2.0 de l‚Äôappli PHP (et faire un rollback si n√©cessaire)</p>
<h3 id="ajout-de-strat√©gie-de-rolling-update">1. Ajout de strat√©gie de rolling update</h3>
<p>Dans les fichiers de sp√©cification <code>myphp_frontend.yaml</code> et <code>myphp_backend.yaml</code>, ajouter une strat√©gie de rolling update pour avoir 0 downtime et un max replicas suppl√©mentaire √† 1</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb42-1"><a href="#cb42-1"></a><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="at">  </span><span class="fu">type</span><span class="kw">:</span><span class="at"> RollingUpdate</span></span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="at">  </span><span class="fu">rollingUpdate</span><span class="kw">:</span></span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="at">    </span><span class="fu">maxSurge</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="at">    </span><span class="fu">maxUnavailable</span><span class="kw">:</span><span class="at"> </span><span class="dv">0</span></span></code></pre></div>
<h3 id="update-des-ressources-deployment">2. Update des ressources deployment</h3>
<p>Appliquer les nouvelles spec : <code>kubectl apply</code></p>
<h2 id="v√©rification-de-lapplication-de-la-strat√©gie-dans-le-dashboard">3. V√©rification de l‚Äôapplication de la strat√©gie dans le dashboard</h2>
<p><img src="2021-07-16-POEI-Kubernetes/2021-07-20_12h27_17.png" /></p>
<h2 id="faire-un-scale-√†-10-r√©plicas-du-d√©ploiement-frontend">4. Faire un scale √† 10 r√©plicas du d√©ploiement frontend</h2>
<div class="info">
On peut utiliser le dashboard pour faire la mise √† l‚Äô√©chelle (la commande kubectl est affich√©e)
</div>
<h2 id="r√©aliser-un-rolling-update-du-d√©ploiement-frontend">5. R√©aliser un rolling update du d√©ploiement frontend :</h2>
<blockquote>
<p>Passage de l‚Äôimage bilbloke en 2.0 en m√©thode imp√©rative =&gt; test</p>
</blockquote>
<blockquote>
<p>R√©p√©rer le nom du d√©ploiement (kubectl get), rep√©rer le nom du conteneur (spec yaml)</p>
</blockquote>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1"></a>$ <span class="ex">kubectl</span> set image {nom du d√©ploiement frontend} <span class="dt">{conteneur}</span>=<span class="ex">bilbloke</span>/frontend:<span class="ex">2.0</span> --record</span></code></pre></div>
<p>R√©sultat:</p>
<iframe src="2021-07-16-POEI-Kubernetes/2021-07-20_12h20_33.mp4">
</iframe>
<hr />
<h1 id="documentation">Documentation</h1>
<h2 id="client-kubectl">Client Kubectl</h2>
<ul>
<li>Info sur le cluster :</li>
</ul>
<div class="sourceCode" id="cb44"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1"></a>$ <span class="ex">kubectl</span> cluster-info</span></code></pre></div>
<ul>
<li>Info sur les nodes :</li>
</ul>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1"></a>$ <span class="ex">kubectl</span> get nodes</span>
<span id="cb45-2"><a href="#cb45-2"></a>$ <span class="ex">kubectl</span> get nodes -o wide</span></code></pre></div>
<h2 id="configuration-du-client">Configuration du client :</h2>
<ul>
<li>Configuration kubectl
<ul>
<li>Cient qui permet de manager des culster K8S</li>
<li>Contextes √† configurer
<ul>
<li><ol type="a">
<li>fichier de config ou variables d‚Äôenvironnement</li>
</ol></li>
<li><ol start="2" type="a">
<li>Ligne de commande : kubectl config ‚Äìhelp</li>
</ol></li>
</ul></li>
</ul></li>
</ul>
<h2 id="lister-les-ressources-k8s">Lister les ressources k8s</h2>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1"></a>$ <span class="ex">kubectl</span> api-resources</span></code></pre></div>
<h2 id="lister-les-ressources-cr√©√©es-dans-le-cluster">Lister les ressources cr√©√©es dans le cluster</h2>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1"></a>$ <span class="ex">kubectl</span> get pod</span>
<span id="cb47-2"><a href="#cb47-2"></a>$ <span class="ex">kubectl</span> get pod -n multi</span>
<span id="cb47-3"><a href="#cb47-3"></a></span>
<span id="cb47-4"><a href="#cb47-4"></a></span>
<span id="cb47-5"><a href="#cb47-5"></a></span>
<span id="cb47-6"><a href="#cb47-6"></a><span class="co">## R√©cuperer de l&#39;info dans le cluster </span></span>
<span id="cb47-7"><a href="#cb47-7"></a></span>
<span id="cb47-8"><a href="#cb47-8"></a><span class="op">&gt;</span> <span class="ex">On</span> interroge des ressources</span>
<span id="cb47-9"><a href="#cb47-9"></a></span>
<span id="cb47-10"><a href="#cb47-10"></a><span class="kw">```</span><span class="fu">bash</span></span>
<span id="cb47-11"><a href="#cb47-11"></a>$ <span class="ex">kubectl</span> get pod</span></code></pre></div>
<blockquote>
<p>Les ressources sont d√©clar√©e dans des namespace. Cela permet de ranger, dissocier des ressources par √©quipe, projets, fonctionnalit√©s, environnement.</p>
</blockquote>
<ul>
<li>Interroger la ressources de type pod dans le namespace systeme : kube-system</li>
</ul>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1"></a>$ <span class="ex">kubectl</span> get pod -n kube-system</span></code></pre></div>
<h2 id="documentation---aide">Documentation - aide</h2>
<ul>
<li>Lister les ressources :</li>
</ul>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1"></a>$ <span class="ex">kubectl</span> api-resources</span></code></pre></div>
<ul>
<li>Description, information, syntaxe :</li>
</ul>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb50-1"><a href="#cb50-1"></a>$ <span class="ex">kubectl</span> explain pods</span>
<span id="cb50-2"><a href="#cb50-2"></a>$ <span class="ex">kubectl</span> explain pods.spec</span>
<span id="cb50-3"><a href="#cb50-3"></a>$ <span class="ex">kubectl</span> explain pods.spec.containers</span></code></pre></div>
<h2 id="les-pods">LES PODS</h2>
<ul>
<li><p><a href="https://kubernetes.io/fr/docs/concepts/workloads/pods/pod-overview/" class="uri">https://kubernetes.io/fr/docs/concepts/workloads/pods/pod-overview/</a></p></li>
<li><p><a href="https://kubernetes.io/fr/docs/concepts/workloads/pods/pod/" class="uri">https://kubernetes.io/fr/docs/concepts/workloads/pods/pod/</a></p></li>
<li><p><a href="https://kubernetes.io/fr/docs/concepts/workloads/pods/pod-lifecycle/" class="uri">https://kubernetes.io/fr/docs/concepts/workloads/pods/pod-lifecycle/</a></p></li>
<li><p><a href="https://kubernetes.io/fr/docs/concepts/workloads/pods/init-containers/" class="uri">https://kubernetes.io/fr/docs/concepts/workloads/pods/init-containers/</a></p></li>
<li><p><a href="https://kubernetes.io/fr/docs/tasks/configure-pod-container/configure-pod-initialization/" class="uri">https://kubernetes.io/fr/docs/tasks/configure-pod-container/configure-pod-initialization/</a></p></li>
</ul>
<h3 id="approche-imp√©rative">Approche imp√©rative</h3>
<blockquote>
<p>Approche imp√©rative : en ligne de commande pour d√©clarer des ressource</p>
</blockquote>
<ol type="1">
<li>Cr√©ation d‚Äôune ressource de type pod :</li>
</ol>
<div class="sourceCode" id="cb51"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1"></a>$ <span class="ex">kubectl</span> run nginx --image nginx:1.18-alpine</span></code></pre></div>
<ol start="2" type="1">
<li>Lister le pod (namespace default)</li>
</ol>
<div class="sourceCode" id="cb52"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1"></a>$ <span class="ex">kubectl</span> get pods</span></code></pre></div>
<ol start="3" type="1">
<li>Obtenir les infos sur la ressource pod + les events (logs)</li>
</ol>
<div class="sourceCode" id="cb53"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1"></a>$ <span class="ex">kubectl</span> describe pod nginx</span></code></pre></div>
<ol start="4" type="1">
<li>Utilisation du port-forwarding pour bind un port local vers le pod (test, debugging)</li>
</ol>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/" class="uri">https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/</a></li>
</ul>
<div class="sourceCode" id="cb54"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1"></a>$ <span class="ex">kubectl</span> port-forward nginx 8080:80</span></code></pre></div>
<ol start="5" type="1">
<li>Transposer les commande docker √† kubernetes</li>
</ol>
<ul>
<li>docker container exec -it ==&gt; kubectl exec -it nginx ‚Äìsh</li>
<li>docker logs ==&gt; kubectl logs nginx</li>
</ul>
<ol start="6" type="1">
<li>Supprimer une ressource POD :</li>
</ol>
<div class="sourceCode" id="cb55"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1"></a><span class="ex">kubectl</span> delete pod nginx</span></code></pre></div>
<h3 id="approche-d√©clarative">Approche d√©clarative</h3>
<blockquote>
<p>Approche d√©clarative : spec (sp√©cification YAML)</p>
</blockquote>
<ol type="1">
<li>Utiliser la commande imp√©rative pour g√©n√©rer un fichier de spec</li>
</ol>
<div class="sourceCode" id="cb56"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1"></a>$ <span class="ex">kubectl</span> run nginx --image nginx:1.18-alpine --dry-run=client -o yaml <span class="op">&gt;</span> spec_pod.yml</span></code></pre></div>
<ol start="2" type="1">
<li>D√©clarer la ressource</li>
</ol>
<div class="sourceCode" id="cb57"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1"></a>$ <span class="ex">kubectl</span> apply -f spec_pod.yml</span></code></pre></div>
<h2 id="mise-en-r√©seau---service">Mise en r√©seau - service</h2>
<ul>
<li><p><a href="https://kubernetes.io/fr/docs/concepts/services-networking/service/" class="uri">https://kubernetes.io/fr/docs/concepts/services-networking/service/</a></p></li>
<li><p><a href="https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/" class="uri">https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/</a></p></li>
</ul>
<h2 id="replicatset-et-deployments">ReplicatSet et Deployments</h2>
<ul>
<li><p><a href="https://kubernetes.io/fr/docs/concepts/workloads/controllers/replicaset/" class="uri">https://kubernetes.io/fr/docs/concepts/workloads/controllers/replicaset/</a></p></li>
<li><p><a href="https://kubernetes.io/fr/docs/concepts/workloads/controllers/deployment/" class="uri">https://kubernetes.io/fr/docs/concepts/workloads/controllers/deployment/</a></p></li>
</ul>
<h2 id="scaling-horizontal---mise-√†-l√©chelle">Scaling horizontal - Mise √† l‚Äô√©chelle</h2>
<p>https://kubernetes.io/docs/tutorials/kubernetes-basics/scale/scale-intro/</p>
<p>https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/</p>
<ul>
<li><strong><em>HPA</em></strong> : Horizontal Pod Autoscale</li>
</ul>
<blockquote>
<p>Pr√©requis : activation des <strong>metrics</strong> pour les Pods</p>
</blockquote>
<div class="sourceCode" id="cb58"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1"></a>$ <span class="ex">kubectl.exe</span> -n myphp scale deployment.apps/frontend-deploy --replicas=8</span>
<span id="cb58-2"><a href="#cb58-2"></a><span class="ex">deployment.apps/frontend-deploy</span> scaled</span></code></pre></div>
<p>R√©sultat sur le Dashboard <em>(minikube)</em>:</p>
<p><img src="2021-07-16-POEI-Kubernetes/2021-07-19_14h12_08.png" /></p>
<h2 id="configmaps">ConfigMaps</h2>
<p>https://kubernetes.io/docs/concepts/configuration/configmap/</p>
<ul>
<li>Lister les ressources configMaps : il faut les chercher explicitement</li>
</ul>
<div class="sourceCode" id="cb59"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb59-1"><a href="#cb59-1"></a>$ <span class="ex">kubectl</span> get cm</span>
<span id="cb59-2"><a href="#cb59-2"></a>$ <span class="ex">kubectl</span> get configmaps</span></code></pre></div>
<ul>
<li>Lister pod et configMaps du namespace default</li>
</ul>
<div class="sourceCode" id="cb60"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1"></a>$ <span class="ex">kubectl</span> get configmaps,pod</span></code></pre></div>
<hr />
<h1 id="tips-tricks"><em>Tips &amp; Tricks</em></h1>
<h2 id="cheatsheet">Cheatsheet</h2>
<p><img src="2021-07-16-POEI-Kubernetes/kubernetes-cheatsheet.png" /></p>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<hr />
<h5 id="the-end" align="center">The End</h5>
<hr />

<div class="footer" id="bottom">
  <p> *** <a href="#top">Top / D√©but</a> - <a href="Index_des_Documentations.html">Index des Documentations</a> - <a href="#the-end">Bottom / Fin</a> *** </p>
</div>
</body>
</html>
