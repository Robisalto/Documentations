<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Pierre SABLE" />
  <meta name="dcterms.date" content="2021-07-21" />
  <title>POEI DevOps - Puppet</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="styleDark.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  
</head>
<body>
<header id="title-block-header">
<h1 class="title">POEI DevOps - Puppet</h1>
<p class="author">Pierre SABLE</p>
<p class="date">2021-07-21</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#doc-source">Doc Source</a>
<ul>
<li><a href="#docs-officielles">Docs officielles</a></li>
<li><a href="#code-source">Code source</a></li>
<li><a href="#puppet-vs-ansible">Puppet VS Ansible</a></li>
<li><a href="#fichiers-de-configuration-puppet">Fichiers de configuration Puppet</a></li>
</ul></li>
<li><a href="#image-vagrant-pierre">Image Vagrant <em>(Pierre)</em></a>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#vérification">Vérification</a></li>
</ul></li>
<li><a href="#tp">TP</a>
<ul>
<li><a href="#ajout-dun-agent-puppet-dans-linfra-puppetserver">Ajout d’un agent puppet dans l’infra puppetserver</a></li>
<li><a href="#certificats-puppet">Certificats Puppet</a></li>
</ul></li>
<li><a href="#vocabulaire-puppet">Vocabulaire Puppet</a></li>
<li><a href="#resource">Resource</a></li>
<li><a href="#tp-ressources">TP Ressources</a>
<ul>
<li><a href="#exercice-1-découverte-des-ressources-puppet">Exercice 1: découverte des ressources puppet</a></li>
<li><a href="#exercice-2-ecriture-dun-manifest">Exercice 2: Ecriture d’un manifest</a></li>
</ul></li>
<li><a href="#configuration-du-master-environement-de-production">Configuration du Master <em>(environement de production)</em></a>
<ul>
<li><a href="#astuce-environnement-de-code">Astuce environnement de code</a></li>
</ul></li>
<li><a href="#puppet-agent-service-client-3">Puppet agent service <em>(Client 3)</em></a>
<ul>
<li><a href="#création-de-la-vm">Création de la vm</a>
<ul>
<li><a href="#vérification-1">Vérification</a></li>
</ul></li>
<li><a href="#ajout-de-la-vm-dans-puppet-server">Ajout de la vm dans Puppet Server</a>
<ul>
<li><a href="#sur-cli03">Sur Cli03</a></li>
<li><a href="#sur-le-puppet-server">Sur le Puppet Server</a></li>
</ul></li>
</ul></li>
<li><a href="#class-sites">Class &amp; Sites</a>
<ul>
<li><a href="#configuration-sur-le-serveur">Configuration sur le Serveur</a></li>
<li><a href="#sur-les-clients">Sur les Clients</a></li>
</ul></li>
<li><a href="#parser-validate">Parser Validate</a>
<ul>
<li><a href="#création-derreurs">Création d’erreurs</a>
<ul>
<li><a href="#erreur-syntaxe">Erreur syntaxe</a></li>
<li><a href="#erreur-dupplicat-de-class">Erreur: dupplicat de Class</a></li>
</ul></li>
</ul></li>
<li><a href="#noop">noop</a></li>
<li><a href="#facts-facters">Facts &amp; Facters</a>
<ul>
<li><a href="#puppet-facts">Puppet Facts</a></li>
</ul></li>
<li><a href="#demo_vars">Demo_Vars</a>
<ul>
<li><a href="#string-undef-int">String, undef, int</a>
<ul>
<li><a href="#tableau">Tableau</a></li>
<li><a href="#hash-dictionnaire">Hash <em>(dictionnaire)</em></a></li>
<li><a href="#facts-osfamily-distro">Facts <em>(osfamily, distro)</em></a></li>
</ul></li>
</ul></li>
<li><a href="#conditionnals-loops">Conditionnals &amp; Loops</a></li>
<li><a href="#tp-vars-facts-conditionnals">TP Vars + Facts + conditionnals</a>
<ul>
<li><a href="#exercice-1">Exercice 1:</a>
<ul>
<li><a href="#réalisation">Réalisation</a></li>
</ul></li>
</ul></li>
<li><a href="#tp-classe-paramétrable">TP Classe paramétrable</a>
<ul>
<li><a href="#exercice-1-créer-le-manifest-manage_tz.pp-dans-codeenvironmentsproductionmanifests">Exercice 1 : Créer le manifest <code>manage_tz.pp</code> dans <em>code/environments/production/manifests</em></a></li>
<li><a href="#exercice-2-un-nouveau-projet-demande-lintégration-dun-node-anglophone">Exercice 2 : Un nouveau projet demande l’intégration d’un node anglophone</a></li>
<li><a href="#soluces">Soluces</a></li>
</ul></li>
<li><a href="#modules-puppet">Modules Puppet</a>
<ul>
<li><a href="#création-du-module-en-ligne-de-commande">Création du module en ligne de commande :</a>
<ul>
<li><a href="#arborescence-du-module">Arborescence du module</a></li>
</ul></li>
</ul></li>
<li><a href="#tips-tricks">Tips &amp; Tricks</a></li>
</ul>
</nav>
<link rel="icon" href="favicon.png" type="image/png" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/highlight.min.js"></script>
<p><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/css.min.js"> <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/styles/atom-one-light.min.css"></p>
<h4 id="introduction">Introduction</h4>
<p><strong>Pierre SABLE</strong> Formateur</p>
<p>Découvrez notre webTV : <a href="http://www.dawan.tv" class="uri">http://www.dawan.tv</a></p>
<hr />
<h1 id="doc-source">Doc Source</h1>
<iframe src="2021-07-21-POEI-Puppet/Puppet.pdf" allowfullscreen="true">
</iframe>
<p>Document: <a href="2021-07-21-POEI-Puppet/Puppet.pdf">Puppet.pdf</a></p>
<h2 id="docs-officielles">Docs officielles</h2>
<ul>
<li><a href="https://puppet.com/" class="uri">https://puppet.com/</a></li>
<li><a href="https://puppet.com/docs/" class="uri">https://puppet.com/docs/</a> &amp; <a href="https://puppet.com/docs/puppet/latest" class="uri">https://puppet.com/docs/puppet/latest</a></li>
</ul>
<h2 id="code-source">Code source</h2>
<p><a href="2021-07-21-POEI-Puppet/poec_devops_puppet">poec_devops_puppet</a></p>
<h2 id="puppet-vs-ansible">Puppet VS Ansible</h2>
<div class="info">
<p><strong>Ansible</strong> et <strong>Puppet</strong> peuvent être utlisés tous les deux dans un même SI.</p>
<p>Il ont des fonctionnalitées, utilisations et résultats différents qui peuvent être <strong>complémentaires</strong>.</p>
</div>
<p><img src="https://i1.wp.com/foxutech.com/wp-content/uploads/2017/04/Differences-between-Ansible-and-Puppet.png?resize=696%2C290&amp;ssl=1" /></p>
<p>Line: <a href="https://foxutech.com/differences-between-ansible-and-puppet/" class="uri">https://foxutech.com/differences-between-ansible-and-puppet/</a></p>
<iframe src="2021-07-21-POEI-Puppet/Puppet-officiel.pdf" allowfullscreen="yes">
</iframe>
<p>Lien: <a href="2021-07-21-POEI-Puppet/Puppet-officiel.pdf">Puppet-officiel.pdf</a></p>
<h2 id="fichiers-de-configuration-puppet">Fichiers de configuration Puppet</h2>
<p>Les fichiers de configurations sont écrits en DSL Ruby: <a href="https://puppet.com/blog/ruby-dsl/" class="uri">https://puppet.com/blog/ruby-dsl/</a></p>
<h1 id="image-vagrant-pierre">Image Vagrant <em>(Pierre)</em></h1>
<h2 id="installation">Installation</h2>
<h2 id="vérification">Vérification</h2>
<p>On se connecte dans la VM: <code>vagrant ssh ppmaster.formation.lan</code></p>
<p>Puis on vérifie l’installation de <strong>Puppet</strong>:</p>
<h5 id="liste-des-paquets-puppet">Liste des Paquets <em>Puppet</em></h5>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">vagrant@ppmaster</span>:~$ apt list <span class="kw">|</span> <span class="fu">grep</span> puppet</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="ex">WARNING</span>: apt does not have a stable CLI interface. Use with caution in scripts.</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="ex">elpa-puppet-mode/focal</span> 0.3+132.g7dee1b5-2 all</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="ex">etherpuppet/focal</span> 0.3-3.1 amd64</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="ex">fusiondirectory-plugin-puppet-schema/focal</span> 1.3-2 all</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="ex">fusiondirectory-plugin-puppet/focal</span> 1.3-2 all</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="ex">libpuppetlabs-http-client-clojure/focal</span> 0.9.0-1 all</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="ex">libpuppetlabs-i18n-clojure/focal</span> 0.8.0-1 all</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="ex">libpuppetlabs-ring-middleware-clojure/focal</span> 1.0.0-2 all</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="ex">librarian-puppet-simple/focal</span> 0.0.5-3 all</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="ex">librarian-puppet/focal</span> 3.0.0-1 all</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="ex">mcollective-plugins-puppetca/focal</span> 0.0.0~git20120507.df2fa81-0ubuntu2 all</span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="ex">mcollective-plugins-puppetd/focal</span> 0.0.0~git20120507.df2fa81-0ubuntu2 all</span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="ex">mcollective-plugins-puppetral/focal</span> 0.0.0~git20120507.df2fa81-0ubuntu2 all</span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="ex">puppet-agent/focal</span> 7.9.0-1focal amd64 [upgradable from: 7.8.0-1focal]</span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="ex">puppet-beaker/focal</span> 4.1.0-1 all</span></code></pre></div>
<h5 id="configuration-docker">Configuration <em>Docker</em></h5>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="ex">vagrant@ppmaster</span>:~$ docker ps</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="ex">CONTAINER</span> ID   IMAGE               COMMAND               CREATED      STATUS        PORTS     NAMES</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="ex">2d380b379ea2</span>   puppet/centos:1.0   <span class="st">&quot;tail -f /dev/null&quot;</span>   7 days ago   Up 18 hours             cli02.formation.lan</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="ex">e51491507dd1</span>   puppet/debian:1.0   <span class="st">&quot;tail -f /dev/null&quot;</span>   7 days ago   Up 18 hours             cli01.formation.lan</span>
<span id="cb2-6"><a href="#cb2-6"></a></span></code></pre></div>
<h5 id="service-status">Service status</h5>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Status service puppetserver:</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="ex">root@ppmaster</span>:~# systemctl status puppetserver.service </span>
<span id="cb3-3"><a href="#cb3-3"></a>● <span class="ex">puppetserver.service</span> - puppetserver Service</span>
<span id="cb3-4"><a href="#cb3-4"></a>     <span class="ex">Loaded</span>: loaded (/lib/systemd/system/puppetserver.service<span class="kw">;</span> <span class="ex">disabled</span><span class="kw">;</span> <span class="ex">vendor</span> preset: enabled)</span>
<span id="cb3-5"><a href="#cb3-5"></a>     <span class="ex">Active</span>: inactive (dead)</span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="ex">root@ppmaster</span>:~# systemctl start puppetserver.service </span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="ex">root@ppmaster</span>:~# systemctl enable puppetserver.service</span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="ex">Synchronizing</span> state of puppetserver.service with SysV service script with /lib/systemd/systemd-sysv-install.</span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="ex">Executing</span>: /lib/systemd/systemd-sysv-install enable puppetserver</span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="ex">Created</span> symlink /etc/systemd/system/multi-user.target.wants/puppetserver.service → /lib/systemd/system/puppetserver.service.</span></code></pre></div>
<p>Plus d’infos sur <code>Systemctl</code>: <a href="https://opensharing.fr/commandes-linux-systemctl" class="uri">https://opensharing.fr/commandes-linux-systemctl</a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Liste de Containers</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="ex">root@ppmaster</span>:~# docker ps</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="ex">CONTAINER</span> ID   IMAGE               COMMAND               CREATED      STATUS        PORTS     NAMES</span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="ex">2d380b379ea2</span>   puppet/centos:1.0   <span class="st">&quot;tail -f /dev/null&quot;</span>   7 days ago   Up 19 hours             cli02.formation.lan</span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="ex">e51491507dd1</span>   puppet/debian:1.0   <span class="st">&quot;tail -f /dev/null&quot;</span>   7 days ago   Up 19 hours             cli01.formation.lan</span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co"># Connexion dans le Container</span></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="ex">root@ppmaster</span>:~# docker container exec -it cli01.formation.lan bash</span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="co"># Liste des paquets &quot;puppet&quot;</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="ex">root@cli01</span>:/# apt list <span class="kw">|</span> <span class="fu">grep</span> puppet</span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="ex">puppet-agent/now</span> 7.8.0-1buster amd64 [installed,local]</span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="ex">puppet7-release/now</span> 7.0.0-2buster all [installed,local]</span></code></pre></div>
<h1 id="tp">TP</h1>
<h2 id="ajout-dun-agent-puppet-dans-linfra-puppetserver">Ajout d’un agent puppet dans l’infra puppetserver</h2>
<h5 id="connexion-dans-la-vm">1. Connexion dans la VM</h5>
<p>Connexion dans la VM <code>ppmaster</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">Admin</span> stagiaire@BBG58Y2 MINGW64 ~/FORMATION/Puppet</span>
<span id="cb5-2"><a href="#cb5-2"></a>$ <span class="ex">vagrant</span> ssh</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="ex">Welcome</span> to Ubuntu 20.04.2 LTS (GNU/Linux 5.4.0-73-generic x86_64)</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="ex">...</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="ex">vagrant@ppmaster</span>:~$ </span></code></pre></div>
<h5 id="connexion-dans-le-client">2. Connexion dans le client</h5>
<p>Dans notre cas le client est: <em>cli02.formation.lan</em></p>
<p>On se connecte dedans:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">vagrant@ppmaster</span>:~$ docker exec -it cli02.formation.lan bash</span>
<span id="cb6-2"><a href="#cb6-2"></a>[<span class="ex">root@cli02</span> /]# </span></code></pre></div>
<p>On vérifie la communication avec le <strong>puppetserver</strong>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a>[<span class="ex">root@cli02</span> /]# ping puppet</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="ex">PING</span> puppet (172.16.8.11) <span class="ex">56</span>(84) <span class="ex">bytes</span> of data.</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="ex">64</span> bytes from puppet (172.16.8.11)<span class="bu">:</span> icmp_seq=1 ttl=64 time=0.056 ms       </span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="ex">64</span> bytes from puppet (172.16.8.11)<span class="bu">:</span> icmp_seq=2 ttl=64 time=0.049 ms</span>
<span id="cb7-5"><a href="#cb7-5"></a>^<span class="ex">C</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="ex">---</span> puppet ping statistics ---</span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="ex">2</span> packets transmitted, 2 received, 0% packet loss, time 4ms</span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="ex">rtt</span> min/avg/max/mdev = 0.049/0.052/0.056/0.008 ms</span></code></pre></div>
<h5 id="déclencher-lagent-manuellement">3. Déclencher l’agent manuellement</h5>
<p>Création du certificat de l’agent Puppet:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a>[<span class="ex">root@cli02</span> /]# /opt/puppetlabs/bin/puppet agent -t</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="ex">Info</span>: Creating a new RSA SSL key for cli02.formation.lan</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="ex">Info</span>: csr_attributes file loading from /etc/puppetlabs/puppet/csr_attributes.yaml</span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="ex">Info</span>: Creating a new SSL certificate request for cli02.formation.lan</span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="ex">Info</span>: Certificate Request fingerprint (SHA256)<span class="bu">:</span> DA:CC:92:21:3F:33:43:74:5D:E2:C0:FE:30:93:06:85:54:4D:E8:64:65:82:D1:9F:FA:61:35:61:E0:22:AB:FA</span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="ex">Info</span>: Certificate for cli02.formation.lan has not been signed yet</span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="ex">Couldn</span><span class="st">&#39;t fetch certificate from CA server; you might still need to sign this agent&#39;</span>s certificate (cli02.formation.lan)<span class="ex">.</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="ex">Exiting</span> now because the waitforcert setting is set to 0.</span></code></pre></div>
<h5 id="vérification-signature">4. Vérification &amp; Signature</h5>
<p>Vérifier et signer le requete de signature de certificat côté puppetserver:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="ex">root@ppmaster</span>:~# puppetserver ca list</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="ex">Requested</span> Certificates:</span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="ex">ppmaster.home</span>             (SHA256)  <span class="ex">EF</span>:F4:48:8D:7D:7B:B6:86:FB:DD:CD:CE:07:E8:D7:FD:E0:B2:E7:4C:D4:18:FE:EC:E9:77:04:81:A9:9D:D8:B8</span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="ex">cli02.formation.lan</span>       (SHA256)  <span class="ex">DA</span>:CC:92:21:3F:33:43:74:5D:E2:C0:FE:30:93:06:85:54:4D:E8:64:65:82:D1:9F:FA:61:35:61:E0:22:AB:FA</span>
<span id="cb9-5"><a href="#cb9-5"></a>    <span class="ex">cli01.formation.lan</span>       (SHA256)  <span class="ex">DD</span>:CE:16:9A:F1:B4:EF:4F:C9:C8:4E:34:F9:2E:B9:3E:76:E7:1C:5E:63:9E:0E:9A:4E:66:AB:B4:79:A9:B2:2D</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="ex">root@ppmaster</span>:~# puppetserver ca sign --certname cli01.formation.lan</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="ex">Successfully</span> signed certificate request for cli02.formation.lan</span></code></pre></div>
<h5 id="application-du-catalogue">5. Application du catalogue</h5>
<p>Redéclencher l’agent pour appliquer le catalogue:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a>[<span class="ex">root@cli02</span> /]# /opt/puppetlabs/bin/puppet agent -t</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="ex">Info</span>: csr_attributes file loading from /etc/puppetlabs/puppet/csr_attributes.yaml</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="ex">Info</span>: Creating a new SSL certificate request for cli02.formation.lan</span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="ex">Info</span>: Certificate Request fingerprint (SHA256)<span class="bu">:</span> DA:CC:92:21:3F:33:43:74:5D:E2:C0:FE:30:93:06:85:54:4D:E8:64:65:82:D1:9F:FA:61:35:61:E0:22:AB:FA</span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="ex">Info</span>: Downloaded certificate for cli02.formation.lan from https://puppet:8140/puppet-ca/v1</span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="ex">Info</span>: Using configured environment <span class="st">&#39;production&#39;</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="ex">Info</span>: Retrieving pluginfacts</span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="ex">Info</span>: Retrieving plugin</span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="ex">Info</span>: Caching catalog for cli02.formation.lan</span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="ex">Info</span>: Applying configuration version <span class="st">&#39;1626872380&#39;</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="ex">Info</span>: Creating state file /opt/puppetlabs/puppet/cache/state/state.yaml</span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="ex">Notice</span>: Applied catalog in 0.02 seconds</span></code></pre></div>
<h2 id="certificats-puppet">Certificats Puppet</h2>
<div class="info">
<p>Pour afficher les certificats <strong>en attente</strong> de signature:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="ex">root@ppmaster</span>:~# ls /etc/puppetlabs/puppetserver/ca/requests/</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="ex">cli01.formation.lan.pem</span>  cli02.formation.lan.pem  ppmaster.home.pem</span></code></pre></div>
<p>Pour afficher les certificats <strong>signés</strong>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a><span class="ex">root@ppmaster</span>:~# ls /etc/puppetlabs/puppetserver/ca/signed/</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="ex">ppmaster.formation.lan.pem</span></span></code></pre></div>
</div>
<h1 id="vocabulaire-puppet">Vocabulaire Puppet</h1>
<ul>
<li><p><strong>Node</strong> : serveur ou poste de travail administré par Puppet</p></li>
<li><p><strong>Site</strong> : ensemble des noeuds gérés par le Puppet Master</p></li>
<li><p><strong>Resource</strong> : objet que Puppet peut manipuler</p></li>
<li><p><strong>Classe</strong> : moyen dans Puppet de séparer des morceaux de code</p></li>
<li><p><strong>Module</strong> : unité de code Puppet qui est réutilisable et pouvant être partagé</p></li>
<li><p><strong>Facter</strong> : librairie multi-plateforme qui fournit à Puppet sous forme de variables les informations propres au système (nom, adresse ip, système d’exploitation, etc.)</p></li>
<li><p><strong>Manifest</strong> : regroupe un ensemble de ressource.</p></li>
<li><p><strong>Catalog</strong> : ensemble des classes de configuration à appliquer à un nœud</p></li>
</ul>
<h1 id="resource">Resource</h1>
<p>Traduction de configurations vers une syntaxe Puppet:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># user: root</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="ex">root@cli01</span>:/# /opt/puppetlabs/bin/puppet resource user root</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="ex">user</span> { <span class="st">&#39;root&#39;</span>:</span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="ex">ensure</span>             =<span class="op">&gt;</span> <span class="st">&#39;present&#39;</span>,</span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="ex">comment</span>            =<span class="op">&gt;</span> <span class="st">&#39;root&#39;</span>,</span>
<span id="cb14-6"><a href="#cb14-6"></a>  <span class="ex">gid</span>                =<span class="op">&gt;</span> 0,</span>
<span id="cb14-7"><a href="#cb14-7"></a>  <span class="ex">home</span>               =<span class="op">&gt;</span> <span class="st">&#39;/root&#39;</span>,</span>
<span id="cb14-8"><a href="#cb14-8"></a>  <span class="ex">password</span>           =<span class="op">&gt;</span> <span class="st">&#39;*&#39;</span>,</span>
<span id="cb14-9"><a href="#cb14-9"></a>  <span class="ex">password_max_age</span>   =<span class="op">&gt;</span> 99999,</span>
<span id="cb14-10"><a href="#cb14-10"></a>  <span class="ex">password_min_age</span>   =<span class="op">&gt;</span> 0,</span>
<span id="cb14-11"><a href="#cb14-11"></a>  <span class="ex">password_warn_days</span> =<span class="op">&gt;</span> 7,</span>
<span id="cb14-12"><a href="#cb14-12"></a>  <span class="ex">provider</span>           =<span class="op">&gt;</span> <span class="st">&#39;useradd&#39;</span>,</span>
<span id="cb14-13"><a href="#cb14-13"></a>  <span class="ex">shell</span>              =<span class="op">&gt;</span> <span class="st">&#39;/bin/bash&#39;</span>,</span>
<span id="cb14-14"><a href="#cb14-14"></a>  <span class="ex">uid</span>                =<span class="op">&gt;</span> 0,</span>
<span id="cb14-15"><a href="#cb14-15"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># Fichier /etc/profile</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="ex">root@cli01</span>:/# /opt/puppetlabs/bin/puppet resource file /etc/profile</span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="fu">file</span> { <span class="st">&#39;/etc/profile&#39;</span>:</span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="ex">ensure</span>   =<span class="op">&gt;</span> <span class="st">&#39;file&#39;</span>,</span>
<span id="cb15-5"><a href="#cb15-5"></a>  <span class="ex">content</span>  =<span class="op">&gt;</span> <span class="st">&#39;{sha256}b8ffd2c97588047e1cea84b7dfdb68bfde167e2957f667ca2b6ab2929feb4f49&#39;</span>,</span>
<span id="cb15-6"><a href="#cb15-6"></a>  <span class="ex">ctime</span>    =<span class="op">&gt;</span> <span class="st">&#39;2021-07-13 15:37:30 +0000&#39;</span>,</span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="ex">group</span>    =<span class="op">&gt;</span> 0,</span>
<span id="cb15-8"><a href="#cb15-8"></a>  <span class="ex">mode</span>     =<span class="op">&gt;</span> <span class="st">&#39;0644&#39;</span>,</span>
<span id="cb15-9"><a href="#cb15-9"></a>  <span class="ex">mtime</span>    =<span class="op">&gt;</span> <span class="st">&#39;2016-03-04 11:00:00 +0000&#39;</span>,</span>
<span id="cb15-10"><a href="#cb15-10"></a>  <span class="ex">owner</span>    =<span class="op">&gt;</span> 0,</span>
<span id="cb15-11"><a href="#cb15-11"></a>  <span class="ex">provider</span> =<span class="op">&gt;</span> <span class="st">&#39;posix&#39;</span>,</span>
<span id="cb15-12"><a href="#cb15-12"></a>  <span class="bu">type</span>     =<span class="op">&gt;</span> <span class="st">&#39;file&#39;</span>,</span>
<span id="cb15-13"><a href="#cb15-13"></a>}</span></code></pre></div>
<p>On peut ainsi “puppetiser” des configurations 😜</p>
<p><img src="https://emojipedia.org/skype/1.2/winking-face-with-tongue/" /></p>
<h1 id="tp-ressources">TP Ressources</h1>
<h4 id="contexte">Contexte</h4>
<p>La ressource est le concept clé de puppet. Elle représente de manière abstraite tout objet concret géré sur la machine.</p>
<h4 id="objectifs">Objectifs</h4>
<p>Dans ce travail pratique nous allons:</p>
<ul>
<li>nous familiariser avec la commande puppet</li>
<li>découvrir la sous-commande puppet resource</li>
<li>mettre en pratique nos connaissances de base de la syntaxe puppet</li>
<li>écrire notre premier manifest</li>
<li>compiler et appliquer notre premier catalogue</li>
</ul>
<h4 id="prérequis">Prérequis</h4>
<p>être connecté sur votre VM</p>
<h2 id="exercice-1-découverte-des-ressources-puppet">Exercice 1: découverte des ressources puppet</h2>
<p>Nous allons utiliser la commande puppet resource afin de comprendre la correspondance entre le code puppet et l’état de la machine.</p>
<ol type="1">
<li><p>Taper la commande puppet help et prendre connaissance de la sortie</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1"></a>$ <span class="ex">puppet</span> help</span></code></pre></div></li>
<li><p>Taper la commande puppet help resource</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1"></a>$ <span class="ex">puppet</span> resource --help</span></code></pre></div></li>
<li><p>Utiliser la commande adéquate pour lister les types de ressources disponibles</p></li>
</ol>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1"></a><span class="ex">root@cli01</span>:/# puppet describe --list</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="ex">These</span> are the types known to puppet:</span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="ex">augeas</span>          - Apply a change or an array of changes to the  ...</span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="ex">cron</span>            - Installs and manages cron jobs</span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="bu">exec</span>            - Executes external commands</span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="fu">file</span>            - Manages files, including their content, owner ...</span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="ex">filebucket</span>      - A repository for storing and retrieving file  ...</span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="ex">group</span>           - Manage groups</span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="ex">host</span>            - Installs and manages host entries</span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="fu">mount</span>           - Manages mounted filesystems, including puttin ...</span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="ex">notify</span>          - Sends an arbitrary message, specified as a st ...</span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="ex">package</span>         - Manage packages</span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="ex">resources</span>       - This is a metatype that can manage other reso ...</span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="ex">schedule</span>        - Define schedules for Puppet</span>
<span id="cb18-15"><a href="#cb18-15"></a><span class="ex">scheduled_task</span>  - Installs and manages Windows Scheduled Tasks</span>
<span id="cb18-16"><a href="#cb18-16"></a><span class="ex">selboolean</span>      - Manages SELinux booleans on systems with SELi ...</span>
<span id="cb18-17"><a href="#cb18-17"></a><span class="ex">selmodule</span>       - Manages loading and unloading of SELinux poli ...</span>
<span id="cb18-18"><a href="#cb18-18"></a><span class="ex">service</span>         - Manage running services</span>
<span id="cb18-19"><a href="#cb18-19"></a><span class="ex">ssh_authorized_key</span> - Manages SSH authorized keys</span>
<span id="cb18-20"><a href="#cb18-20"></a><span class="ex">sshkey</span>          - Installs and manages ssh host keys</span>
<span id="cb18-21"><a href="#cb18-21"></a><span class="ex">stage</span>           - A resource type for creating new run stages</span>
<span id="cb18-22"><a href="#cb18-22"></a><span class="ex">tidy</span>            - Remove unwanted files based on specific crite ...</span>
<span id="cb18-23"><a href="#cb18-23"></a><span class="ex">user</span>            - Manage users</span>
<span id="cb18-24"><a href="#cb18-24"></a><span class="ex">whit</span>            - Whits are internal artifacts of Puppets curr ...</span>
<span id="cb18-25"><a href="#cb18-25"></a><span class="ex">yumrepo</span>         - The client-side description of a yum reposito ...</span>
<span id="cb18-26"><a href="#cb18-26"></a><span class="ex">zfs</span>             - Manage zfs</span>
<span id="cb18-27"><a href="#cb18-27"></a><span class="ex">zone</span>            - Manages Solaris zones</span>
<span id="cb18-28"><a href="#cb18-28"></a><span class="ex">zpool</span>           - Manage zpools</span></code></pre></div>
<ol start="4" type="1">
<li><p>Utiliser la commande puppet pour représenter la ressource de type user du user root présent su la machine</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1"></a><span class="ex">root@cli01</span>:/# /opt/puppetlabs/bin/puppet resource user root</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="ex">user</span> { <span class="st">&#39;root&#39;</span>:</span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="ex">ensure</span>             =<span class="op">&gt;</span> <span class="st">&#39;present&#39;</span>,</span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="ex">comment</span>            =<span class="op">&gt;</span> <span class="st">&#39;root&#39;</span>,</span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="ex">gid</span>                =<span class="op">&gt;</span> 0,</span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="ex">home</span>               =<span class="op">&gt;</span> <span class="st">&#39;/root&#39;</span>,</span>
<span id="cb19-7"><a href="#cb19-7"></a>  <span class="ex">password</span>           =<span class="op">&gt;</span> <span class="st">&#39;*&#39;</span>,</span>
<span id="cb19-8"><a href="#cb19-8"></a>  <span class="ex">password_max_age</span>   =<span class="op">&gt;</span> 99999,</span>
<span id="cb19-9"><a href="#cb19-9"></a>  <span class="ex">password_min_age</span>   =<span class="op">&gt;</span> 0,</span>
<span id="cb19-10"><a href="#cb19-10"></a>  <span class="ex">password_warn_days</span> =<span class="op">&gt;</span> 7,</span>
<span id="cb19-11"><a href="#cb19-11"></a>  <span class="ex">provider</span>           =<span class="op">&gt;</span> <span class="st">&#39;useradd&#39;</span>,</span>
<span id="cb19-12"><a href="#cb19-12"></a>  <span class="ex">shell</span>              =<span class="op">&gt;</span> <span class="st">&#39;/bin/bash&#39;</span>,</span>
<span id="cb19-13"><a href="#cb19-13"></a>  <span class="ex">uid</span>                =<span class="op">&gt;</span> 0,</span>
<span id="cb19-14"><a href="#cb19-14"></a>}</span></code></pre></div></li>
</ol>
<hr />
<h2 id="exercice-2-ecriture-dun-manifest">Exercice 2: Ecriture d’un manifest</h2>
<ol type="1">
<li><p>Ecrire la définition d’une resource user dans un fichier manifest : <code>manage_user.pp</code></p>
<ul>
<li>Name : test</li>
<li>Shell : /bin/bash</li>
<li>Gecos (commentaire) : “user de test manage par puppet”</li>
</ul></li>
<li><p>Appliquer le manifest localement (standalone)</p></li>
</ol>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1"></a><span class="ex">root@cli01</span>:/# puppet apply manage_user.pp </span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="ex">Notice</span>: Compiled catalog for cli01.formation.lan in environment production in 0.02 seconds</span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="ex">Notice</span>: /Stage[main]/Main/User[test]/ensure: created</span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="ex">Notice</span>: Applied catalog in 0.11 seconds</span></code></pre></div>
<ol start="3" type="1">
<li>Modifier le manifest pour mettre l’utilisateur “test” dans le groupe “formation”</li>
</ol>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1"></a><span class="ex">user</span> { <span class="st">&#39;test&#39;</span>:</span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="ex">ensure</span>    =<span class="op">&gt;</span> <span class="st">&#39;present&#39;</span>,</span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="ex">comment</span>   =<span class="op">&gt;</span> <span class="st">&#39;test&#39;</span>,</span>
<span id="cb21-4"><a href="#cb21-4"></a>  <span class="ex">home</span>      =<span class="op">&gt;</span> <span class="st">&#39;/home/test&#39;</span>,</span>
<span id="cb21-5"><a href="#cb21-5"></a>  <span class="ex">password</span>  =<span class="op">&gt;</span> <span class="st">&#39;test 123&#39;</span>,</span>
<span id="cb21-6"><a href="#cb21-6"></a>  <span class="ex">provider</span>  =<span class="op">&gt;</span> <span class="st">&#39;useradd&#39;</span>,</span>
<span id="cb21-7"><a href="#cb21-7"></a>  <span class="ex">shell</span>     =<span class="op">&gt;</span> <span class="st">&#39;/bin/bash&#39;</span>,</span>
<span id="cb21-8"><a href="#cb21-8"></a>  <span class="fu">groups</span>    =<span class="op">&gt;</span> <span class="st">&#39;formation&#39;</span>,</span>
<span id="cb21-9"><a href="#cb21-9"></a>}</span></code></pre></div>
<div class="alert">
Le groupe <strong>formation</strong> n’existe pas !!!
</div>
<ol start="4" type="1">
<li>Créer le groupe “formation”</li>
</ol>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1"></a><span class="ex">user</span> { <span class="st">&#39;test&#39;</span>:</span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="ex">ensure</span>    =<span class="op">&gt;</span> <span class="st">&#39;present&#39;</span>,</span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="ex">comment</span>   =<span class="op">&gt;</span> <span class="st">&#39;test&#39;</span>,</span>
<span id="cb22-4"><a href="#cb22-4"></a>  <span class="ex">home</span>      =<span class="op">&gt;</span> <span class="st">&#39;/home/test&#39;</span>,</span>
<span id="cb22-5"><a href="#cb22-5"></a>  <span class="ex">password</span>  =<span class="op">&gt;</span> <span class="st">&#39;test 123&#39;</span>,</span>
<span id="cb22-6"><a href="#cb22-6"></a>  <span class="ex">provider</span>  =<span class="op">&gt;</span> <span class="st">&#39;useradd&#39;</span>,</span>
<span id="cb22-7"><a href="#cb22-7"></a>  <span class="ex">shell</span>     =<span class="op">&gt;</span> <span class="st">&#39;/bin/bash&#39;</span>,</span>
<span id="cb22-8"><a href="#cb22-8"></a>  <span class="fu">groups</span>    =<span class="op">&gt;</span> <span class="st">&#39;formation&#39;</span>,</span>
<span id="cb22-9"><a href="#cb22-9"></a>}</span>
<span id="cb22-10"><a href="#cb22-10"></a></span>
<span id="cb22-11"><a href="#cb22-11"></a></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="ex">group</span> { <span class="st">&#39;formation&#39;</span>:</span>
<span id="cb22-13"><a href="#cb22-13"></a>  <span class="ex">ensure</span>   =<span class="op">&gt;</span> <span class="st">&#39;present&#39;</span>,</span>
<span id="cb22-14"><a href="#cb22-14"></a>  <span class="ex">provider</span> =<span class="op">&gt;</span> <span class="st">&#39;groupadd&#39;</span>,</span>
<span id="cb22-15"><a href="#cb22-15"></a>}</span></code></pre></div>
<div class="info">
<p>Puppet ne fonctionne pas de manière séquentielle comme Ansible.</p>
<p>Le manifest est <strong>compilé</strong> avant d’être lancé !</p>
</div>
<h5 id="déclenchement-de-lagent-sur-le-client-2">Déclenchement de l’agent sur le client 2</h5>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a>[<span class="ex">root@cli02</span> /]# puppet agent -t</span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="ex">Info</span>: Using configured environment <span class="st">&#39;production&#39;</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="ex">Info</span>: Retrieving pluginfacts</span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="ex">Info</span>: Retrieving plugin</span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="ex">Info</span>: Caching catalog for cli02.formation.lan</span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="ex">Info</span>: Applying configuration version <span class="st">&#39;1626879808&#39;</span></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="ex">Notice</span>: /Stage[main]/Main/Group[formation]/ensure: created</span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="ex">Notice</span>: /Stage[main]/Main/User[test]/ensure: created</span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="ex">Notice</span>: Applied catalog in 0.15 seconds</span></code></pre></div>
<h1 id="configuration-du-master-environement-de-production">Configuration du Master <em>(environement de production)</em></h1>
<p>Architecture des fichiers de configuration:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1"></a><span class="ex">vagrant@ppmaster</span>:~$ tree /etc/puppetlabs/code/</span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="ex">/etc/puppetlabs/code/</span></span>
<span id="cb24-3"><a href="#cb24-3"></a>├── <span class="ex">environments</span></span>
<span id="cb24-4"><a href="#cb24-4"></a>│   └── <span class="ex">production</span></span>
<span id="cb24-5"><a href="#cb24-5"></a>│       ├── <span class="ex">data</span></span>
<span id="cb24-6"><a href="#cb24-6"></a>│       ├── <span class="ex">environment.conf</span></span>
<span id="cb24-7"><a href="#cb24-7"></a>│       ├── <span class="ex">hiera.yaml</span></span>
<span id="cb24-8"><a href="#cb24-8"></a>│       ├── <span class="ex">manifests</span></span>
<span id="cb24-9"><a href="#cb24-9"></a>│       └── <span class="ex">modules</span></span>
<span id="cb24-10"><a href="#cb24-10"></a>└── <span class="ex">modules</span></span></code></pre></div>
<h2 id="astuce-environnement-de-code">Astuce environnement de code</h2>
<ul>
<li>Copie du répertoire code d’origine dans notre partage (pour pouvoir l’éditer avec vscode)</li>
</ul>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1"></a>$ <span class="fu">cp</span> -r /etc/puppetlabs/code /vagrant/</span></code></pre></div>
<ul>
<li>Suppression du répertoire d’origine pour créer le lien derrière</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1"></a>$ <span class="bu">cd</span> /etc/puppetlabs</span>
<span id="cb26-2"><a href="#cb26-2"></a>$ <span class="fu">rm</span> -rf code</span>
<span id="cb26-3"><a href="#cb26-3"></a>$ <span class="fu">ln</span> -s /vagrant/code code</span>
<span id="cb26-4"><a href="#cb26-4"></a>$ <span class="fu">ls</span> -l</span></code></pre></div>
<h1 id="puppet-agent-service-client-3">Puppet agent service <em>(Client 3)</em></h1>
<h2 id="création-de-la-vm">Création de la vm</h2>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1"></a><span class="ex">docker</span> run -d --name cli03.formation.lan --hostname cli03.formation.lan --tmpfs /tmp --tmpfs /run --tmpfs /run/lock -v /sys/fs/cgroup:/sys/fs/cgroup:ro --add-host=<span class="st">&quot;puppet:172.16.8.11&quot;</span> bilbloke/puppet-systemd:1.0</span></code></pre></div>
<h3 id="vérification-1">Vérification</h3>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1"></a><span class="ex">root@ppmaster</span>:/etc/puppetlabs# docker ps</span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="ex">CONTAINER</span> ID   IMAGE                         COMMAND                  CREATED         STATUS         PORTS     NAMES</span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="ex">c3f83cf51e9c</span>   bilbloke/puppet-systemd:1.0   <span class="st">&quot;/lib/systemd/systemd&quot;</span>   4 minutes ago   Up 4 minutes             cli03.formation.lan</span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="ex">2d380b379ea2</span>   puppet/centos:1.0             <span class="st">&quot;tail -f /dev/null&quot;</span>      8 days ago      Up 40 hours              cli02.formation.lan</span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="ex">e51491507dd1</span>   puppet/debian:1.0             <span class="st">&quot;tail -f /dev/null&quot;</span>      8 days ago      Up 40 hours              cli01.formation.lan</span></code></pre></div>
<h2 id="ajout-de-la-vm-dans-puppet-server">Ajout de la vm dans Puppet Server</h2>
<h3 id="sur-cli03">Sur Cli03</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1"></a><span class="ex">root@cli03</span>:/# . /etc/profile</span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="ex">root@cli03</span>:/# puppet agent -t</span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="ex">Info</span>: csr_attributes file loading from /etc/puppetlabs/puppet/csr_attributes.yaml</span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="ex">Info</span>: Creating a new SSL certificate request for cli03.formation.lan</span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="ex">Info</span>: Certificate Request fingerprint (SHA256)<span class="bu">:</span> 43:9B:01:ED:43:8E:91:9B:21:F7:2E:62:10:32:4D:5A:6F:CE:25:34:C1:F5:8D:45:37:2B:75:CA:9A:F7:7E:77</span>
<span id="cb29-6"><a href="#cb29-6"></a><span class="ex">Info</span>: Certificate for cli03.formation.lan has not been signed yet</span>
<span id="cb29-7"><a href="#cb29-7"></a><span class="ex">Couldn</span><span class="st">&#39;t fetch certificate from CA server; you might still need to sign this agent&#39;</span>s certificate (cli03.formation.lan)<span class="ex">.</span></span>
<span id="cb29-8"><a href="#cb29-8"></a><span class="ex">Exiting</span> now because the waitforcert setting is set to 0.</span></code></pre></div>
<h3 id="sur-le-puppet-server">Sur le Puppet Server</h3>
<h4 id="ca-requests">ca requests</h4>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1"></a><span class="ex">root@ppmaster</span>:/etc/puppetlabs# ll puppetserver/ca/requests/</span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="ex">total</span> 16</span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="ex">drwxr-x---</span> 2 puppet puppet 4096 Jul 22 08:13 ./</span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="ex">drwxr-x---</span> 4 puppet puppet 4096 Jul 21 12:56 ../</span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="ex">-rw-r--r--</span> 1 puppet puppet 1598 Jul 22 08:13 cli03.formation.lan.pem</span></code></pre></div>
<h4 id="signature">Signature</h4>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1"></a><span class="ex">root@ppmaster</span>:/etc/puppetlabs# puppetserver ca sign --certname cli03.formation.lan</span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="ex">Successfully</span> signed certificate request for cli03.formation.lan</span></code></pre></div>
<h5 id="vérification-2">Vérification</h5>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1"></a><span class="ex">root@ppmaster</span>:/etc/puppetlabs# ll puppetserver/ca/signed/</span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="ex">total</span> 24</span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="ex">drwxr-x---</span> 2 puppet puppet 4096 Jul 22 08:21 ./</span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="ex">drwxr-x---</span> 4 puppet puppet 4096 Jul 22 08:21 ../</span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="ex">-rw-r--r--</span> 1 puppet puppet 2004 Jul 21 12:56 cli01.formation.lan.pem</span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="ex">-rw-r--r--</span> 1 puppet puppet 2004 Jul 21 12:56 cli02.formation.lan.pem</span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="ex">-rw-r--r--</span> 1 puppet puppet 2004 Jul 22 08:21 cli03.formation.lan.pem</span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="ex">-rw-r--r--</span> 1 puppet puppet 2057 Jul 21 10:30 ppmaster.formation.lan.pem</span></code></pre></div>
<h4 id="sur-client-3">Sur Client 3</h4>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1"></a><span class="ex">root@cli03</span>:/# puppet agent -t</span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="ex">Info</span>: Using configured environment <span class="st">&#39;production&#39;</span></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="ex">Info</span>: Retrieving pluginfacts</span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="ex">Info</span>: Retrieving plugin</span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="ex">Info</span>: Caching catalog for cli03.formation.lan</span>
<span id="cb33-6"><a href="#cb33-6"></a><span class="ex">Info</span>: Applying configuration version <span class="st">&#39;1626942547&#39;</span></span>
<span id="cb33-7"><a href="#cb33-7"></a><span class="ex">Notice</span>: Applied catalog in 0.04 seconds</span></code></pre></div>
<h1 id="class-sites">Class &amp; Sites</h1>
<h2 id="configuration-sur-le-serveur">Configuration sur le Serveur</h2>
<p>Architecture des fichiers:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1"></a><span class="ex">root@ppmaster</span>:/etc/puppetlabs/code# tree environments/</span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="ex">environments/</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>└── <span class="ex">production</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>    ├── <span class="ex">data</span></span>
<span id="cb34-5"><a href="#cb34-5"></a>    ├── <span class="ex">environment.conf</span></span>
<span id="cb34-6"><a href="#cb34-6"></a>    ├── <span class="ex">hiera.yaml</span></span>
<span id="cb34-7"><a href="#cb34-7"></a>    ├── <span class="ex">manifests</span></span>
<span id="cb34-8"><a href="#cb34-8"></a>    │   ├── <span class="ex">manage_ssh.pp</span></span>
<span id="cb34-9"><a href="#cb34-9"></a>    │   ├── <span class="ex">manage_user.pp</span></span>
<span id="cb34-10"><a href="#cb34-10"></a>    │   └── <span class="ex">site.pp</span></span>
<span id="cb34-11"><a href="#cb34-11"></a>    └── <span class="ex">modules</span></span></code></pre></div>
<p>Dans le fichier <code>site.pp</code>:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb35-1"><a href="#cb35-1"></a><span class="co"># Manifest applied to &#39;cli03.formation.lan&#39;</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>node <span class="st">&#39;cli03.formation.lan&#39;</span> {</span>
<span id="cb35-3"><a href="#cb35-3"></a>  include ::manage_user</span>
<span id="cb35-4"><a href="#cb35-4"></a>  include ::manage_ssh</span>
<span id="cb35-5"><a href="#cb35-5"></a>}</span>
<span id="cb35-6"><a href="#cb35-6"></a></span>
<span id="cb35-7"><a href="#cb35-7"></a><span class="co"># Manifest applied by default for nodes not-declared above</span></span>
<span id="cb35-8"><a href="#cb35-8"></a>node default {</span>
<span id="cb35-9"><a href="#cb35-9"></a>  include ::manage_user</span>
<span id="cb35-10"><a href="#cb35-10"></a>}</span></code></pre></div>
<div class="warning">
La class <em>default</em> sera appliquée aux <em>nodes</em> non déclarés avant.
</div>
<h2 id="sur-les-clients">Sur les Clients</h2>
<p>On lance la commande: <code>puppet agent -t</code> :</p>
<h5 id="client-1">Client 1:</h5>
<div class="sourceCode" id="cb36"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1"></a><span class="ex">root@cli01</span>:/# puppet agent -t</span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="ex">Info</span>: Using configured environment <span class="st">&#39;production&#39;</span></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="ex">Info</span>: Retrieving pluginfacts</span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="ex">Info</span>: Retrieving plugin</span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="ex">Info</span>: Caching catalog for cli01.formation.lan</span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="ex">Info</span>: Applying configuration version <span class="st">&#39;1626957021&#39;</span></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="ex">Notice</span>: class manage_user</span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="ex">Notice</span>: /Stage[main]/Manage_user/Notify[Affichage de la classe user]/message: defined <span class="st">&#39;message&#39;</span> as <span class="st">&#39;class manage_user&#39;</span></span>
<span id="cb36-9"><a href="#cb36-9"></a><span class="ex">Notice</span>: Applied catalog in 0.04 seconds</span></code></pre></div>
<h5 id="client-2">Client 2:</h5>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1"></a>[<span class="ex">root@cli02</span> /]# puppet agent -t</span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="ex">Info</span>: Using configured environment <span class="st">&#39;production&#39;</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="ex">Info</span>: Retrieving pluginfacts</span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="ex">Info</span>: Retrieving plugin</span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="ex">Info</span>: Caching catalog for cli02.formation.lan</span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="ex">Info</span>: Applying configuration version <span class="st">&#39;1626957025&#39;</span></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="ex">Notice</span>: class manage_user</span>
<span id="cb37-8"><a href="#cb37-8"></a><span class="ex">Notice</span>: /Stage[main]/Manage_user/Notify[Affichage de la classe user]/message: defined <span class="st">&#39;message&#39;</span> as <span class="st">&#39;class manage_user&#39;</span></span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="ex">Notice</span>: Applied catalog in 0.05 seconds</span></code></pre></div>
<h5 id="client-3">Client 3:</h5>
<div class="sourceCode" id="cb38"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1"></a><span class="ex">root@cli03</span>:/# puppet agent -t</span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="ex">Info</span>: Using configured environment <span class="st">&#39;production&#39;</span></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="ex">Info</span>: Retrieving pluginfacts</span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="ex">Info</span>: Retrieving plugin</span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="ex">Info</span>: Caching catalog for cli03.formation.lan</span>
<span id="cb38-6"><a href="#cb38-6"></a><span class="ex">Info</span>: Applying configuration version <span class="st">&#39;1626957016&#39;</span></span>
<span id="cb38-7"><a href="#cb38-7"></a><span class="ex">Notice</span>: class manage_user</span>
<span id="cb38-8"><a href="#cb38-8"></a><span class="ex">Notice</span>: /Stage[main]/Manage_user/Notify[Affichage de la classe user]/message: defined <span class="st">&#39;message&#39;</span> as <span class="st">&#39;class manage_user&#39;</span></span>
<span id="cb38-9"><a href="#cb38-9"></a><span class="ex">Notice</span>: class manage_ssh</span>
<span id="cb38-10"><a href="#cb38-10"></a><span class="ex">Notice</span>: /Stage[main]/Manage_ssh/Notify[Affichage de la classe ssh]/message: defined <span class="st">&#39;message&#39;</span> as <span class="st">&#39;class manage_ssh&#39;</span></span>
<span id="cb38-11"><a href="#cb38-11"></a><span class="ex">Notice</span>: Applied catalog in 1.25 seconds</span></code></pre></div>
<div class="success">
<p>Yep All Good !</p>
Les 3 clients récupères bien les manifests qui leurs sont associées.
</div>
<h1 id="parser-validate">Parser Validate</h1>
<p>Permet de vérifier l’intégrité du code:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1"></a><span class="ex">root@ppmaster</span>:/etc/puppetlabs/code# puppet parser validate .</span></code></pre></div>
<div class="info">
Quand tout baigne, pas de retour.
</div>
<h2 id="création-derreurs">Création d’erreurs</h2>
<h3 id="erreur-syntaxe">Erreur syntaxe</h3>
<p>Dans le fichier <code>demo_vars_facts.pp</code> on modifie pour générer une erreur:</p>
<p><img src="2021-07-21-POEI-Puppet/2021-07-22_16h07_13.png" /></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1"></a><span class="ex">root@ppmaster</span>:/etc/puppetlabs/code# puppet parser validate .</span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="ex">Error</span>: Could not parse for environment production: Syntax error at <span class="st">&#39;=&#39;</span> (file: /vagrant/code/environments/production/manifests/demo_vars_facts.pp, line: 21, column: 13)</span></code></pre></div>
<h3 id="erreur-dupplicat-de-class">Erreur: dupplicat de Class</h3>
<p>On créer un fichier <code>test.pp</code> dans lequel on dupplique la class <code>demo_vars</code>:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb41-1"><a href="#cb41-1"></a><span class="co"># test.pp</span></span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="kw">class</span> demo_vars {</span>
<span id="cb41-3"><a href="#cb41-3"></a>}</span></code></pre></div>
<p>Résultat du <code>parser validate</code>:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1"></a><span class="ex">root@ppmaster</span>:/etc/puppetlabs/code# puppet parser validate .</span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="ex">Error</span>: Class <span class="st">&#39;demo_vars&#39;</span> is already defined (file: /vagrant/code/environments/production/manifests/demo_vars_facts.pp, line: 2); <span class="ex">cannot</span> redefine (file: /vagrant/code/environments/production/manifests/test.pp, </span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="ex">line</span>: 1)</span></code></pre></div>
<h1 id="noop">noop</h1>
<p>L’option <code>--noop</code> correspond à un <strong>–dry-run</strong>. Cela permet de <strong>vérifier les actions qui seront réalisées</strong>, sans les appliquées.</p>
<ul>
<li><p>On change dans le fichier <code>manage_ssh.pp</code> le status de l’utilisateur en <code>absent</code></p></li>
<li><p>On lance la commande: <code>puppet agent -t --noop</code> sur le client03:</p></li>
</ul>
<p><img src="2021-07-21-POEI-Puppet/2021-07-22_16h19_25.png" /></p>
<h1 id="facts-facters">Facts &amp; Facters</h1>
<h2 id="puppet-facts">Puppet Facts</h2>
<p>Sur le client:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1"></a><span class="ex">root@cli03</span>:/# puppet facts <span class="kw">|</span> <span class="fu">head</span> -10</span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="kw">{</span></span>
<span id="cb43-3"><a href="#cb43-3"></a>  <span class="st">&quot;os&quot;</span>: <span class="kw">{</span></span>
<span id="cb43-4"><a href="#cb43-4"></a>    <span class="st">&quot;distro&quot;</span>: <span class="kw">{</span></span>
<span id="cb43-5"><a href="#cb43-5"></a>      <span class="st">&quot;codename&quot;</span>: <span class="st">&quot;buster&quot;</span>,</span>
<span id="cb43-6"><a href="#cb43-6"></a>      <span class="st">&quot;description&quot;</span>: <span class="st">&quot;Debian GNU/Linux 10 (buster)&quot;</span>,</span>
<span id="cb43-7"><a href="#cb43-7"></a>      <span class="st">&quot;release&quot;</span>: <span class="kw">{</span></span>
<span id="cb43-8"><a href="#cb43-8"></a>        <span class="st">&quot;full&quot;</span>: <span class="st">&quot;10.10&quot;</span>,</span>
<span id="cb43-9"><a href="#cb43-9"></a>        <span class="st">&quot;major&quot;</span>: <span class="st">&quot;10&quot;</span>,</span>
<span id="cb43-10"><a href="#cb43-10"></a>        <span class="st">&quot;minor&quot;</span>: <span class="st">&quot;10&quot;</span></span>
<span id="cb43-11"><a href="#cb43-11"></a>      <span class="kw">}</span>,</span></code></pre></div>
<ul>
<li>Documentation officielle: <a href="https://puppet.com/docs/puppet/7/lang_facts_accessing.html" class="uri">https://puppet.com/docs/puppet/7/lang_facts_accessing.html</a></li>
</ul>
<h1 id="demo_vars">Demo_Vars</h1>
<p>Dans le fichier <code>demo_vars_facts.pp</code> on créer la classe <code>demo_vars</code> et on teste les différents types de variables.</p>
<h2 id="string-undef-int">String, undef, int</h2>
<div class="sourceCode" id="cb44"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb44-1"><a href="#cb44-1"></a><span class="co"># Variable de type &#39;String&#39;</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>  <span class="dt">$mavarstring</span> = <span class="st">&quot;exemple var string&quot;</span></span>
<span id="cb44-3"><a href="#cb44-3"></a></span>
<span id="cb44-4"><a href="#cb44-4"></a>  <span class="co"># Variable déclarée mais vide</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>  <span class="dt">$futurevar</span> = <span class="kw">undef</span></span>
<span id="cb44-6"><a href="#cb44-6"></a></span>
<span id="cb44-7"><a href="#cb44-7"></a>  <span class="co"># Variable type int</span></span>
<span id="cb44-8"><a href="#cb44-8"></a>  <span class="dt">$int_var</span> = <span class="dv">2021</span></span>
<span id="cb44-9"><a href="#cb44-9"></a></span>
<span id="cb44-10"><a href="#cb44-10"></a>  <span class="co"># Utilisation de variable</span></span>
<span id="cb44-11"><a href="#cb44-11"></a>  notify {<span class="st">&#39;Contenu des variables&#39;</span>:</span>
<span id="cb44-12"><a href="#cb44-12"></a>    message =&gt; <span class="st">&quot;Valeur de mavarstring: ${mavarstring} et Valeur de futurvar: ${futurevar} et Valeur de int_var: ${int_var}&quot;</span>,</span>
<span id="cb44-13"><a href="#cb44-13"></a>  }  </span>
<span id="cb44-14"><a href="#cb44-14"></a></span>
<span id="cb44-15"><a href="#cb44-15"></a>  notify {<span class="st">&#39;INT_VAR&#39;</span>:</span>
<span id="cb44-16"><a href="#cb44-16"></a>    message =&gt; <span class="st">&quot;int_var = ${int_var} &quot;</span>,</span>
<span id="cb44-17"><a href="#cb44-17"></a>  }</span></code></pre></div>
<h5 id="résultat">Résultat:</h5>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1"></a><span class="ex">Notice</span>: Valeur de mavarstring: exemple var string et Valeur de futurvar:  et Valeur de int_var: 2021</span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="ex">Notice</span>: /Stage[main]/Demo_vars/Notify[Contenu des variables]/message: defined <span class="st">&#39;message&#39;</span> as <span class="st">&#39;Valeur de mavarstring: exemple var string et Valeur de futurvar:  et Valeur de int_var: 2021&#39;</span></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="ex">Notice</span>: int_var = 2021</span>
<span id="cb45-4"><a href="#cb45-4"></a><span class="ex">Notice</span>: /Stage[main]/Demo_vars/Notify[INT_VAR]/message: defined <span class="st">&#39;message&#39;</span> as <span class="st">&#39;int_var = 2021 &#39;</span></span></code></pre></div>
<h3 id="tableau">Tableau</h3>
<div class="sourceCode" id="cb46"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb46-1"><a href="#cb46-1"></a><span class="co"># Création d&#39;un tableau</span></span>
<span id="cb46-2"><a href="#cb46-2"></a>  <span class="dt">$tableau</span> = [<span class="st">&#39;puppet&#39;</span>, <span class="st">&#39;7.9.0&#39;</span>]</span>
<span id="cb46-3"><a href="#cb46-3"></a></span>
<span id="cb46-4"><a href="#cb46-4"></a>  notify {<span class="st">&#39;Tableau&#39;</span>:</span>
<span id="cb46-5"><a href="#cb46-5"></a>    message =&gt; <span class="st">&quot; Programme: ${tableau[0]} et Version: ${tableau[1]} \n&quot;</span>,</span>
<span id="cb46-6"><a href="#cb46-6"></a>  }</span></code></pre></div>
<h5 id="résultat-1">Résultat:</h5>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb47-1"><a href="#cb47-1"></a><span class="ex">Notice</span>: /Stage[main]/Demo_vars/Notify[Tableau]/message: defined <span class="st">&#39;message&#39;</span> as <span class="st">&quot; Programme: puppet et Version: 7.9.0 \n&quot;</span></span></code></pre></div>
<h3 id="hash-dictionnaire">Hash <em>(dictionnaire)</em></h3>
<div class="sourceCode" id="cb48"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb48-1"><a href="#cb48-1"></a><span class="co"># Creation d&#39;un hash (dictionnaire)</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>  <span class="dt">$hash</span> = [</span>
<span id="cb48-3"><a href="#cb48-3"></a>    {</span>
<span id="cb48-4"><a href="#cb48-4"></a>      <span class="st">&#39;name&#39;</span> =&gt; <span class="st">&#39;user1&#39;</span>,</span>
<span id="cb48-5"><a href="#cb48-5"></a>      <span class="st">&#39;home&#39;</span> =&gt; <span class="st">&#39;/prd/user1&#39;</span></span>
<span id="cb48-6"><a href="#cb48-6"></a>    },</span>
<span id="cb48-7"><a href="#cb48-7"></a>    {</span>
<span id="cb48-8"><a href="#cb48-8"></a>      <span class="st">&#39;name&#39;</span> =&gt; <span class="st">&#39;user2&#39;</span>,</span>
<span id="cb48-9"><a href="#cb48-9"></a>      <span class="st">&#39;home&#39;</span> =&gt; <span class="st">&#39;/dev/user2&#39;</span></span>
<span id="cb48-10"><a href="#cb48-10"></a>    }</span>
<span id="cb48-11"><a href="#cb48-11"></a>  ]</span>
<span id="cb48-12"><a href="#cb48-12"></a></span>
<span id="cb48-13"><a href="#cb48-13"></a>  notify {<span class="st">&#39;Hash&#39;</span>:</span>
<span id="cb48-14"><a href="#cb48-14"></a>    message =&gt; <span class="st">&quot;${hash[0][&#39;home&#39;]}&quot;</span>,</span>
<span id="cb48-15"><a href="#cb48-15"></a>  }</span></code></pre></div>
<h5 id="résultat-2">Résultat:</h5>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1"></a><span class="ex">Notice</span>: /prd/user1</span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="ex">Notice</span>: /Stage[main]/Demo_vars/Notify[Hash]/message: defined <span class="st">&#39;message&#39;</span> as <span class="st">&#39;/prd/user1&#39;</span></span></code></pre></div>
<h3 id="facts-osfamily-distro">Facts <em>(osfamily, distro)</em></h3>
<div class="sourceCode" id="cb50"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb50-1"><a href="#cb50-1"></a> <span class="co"># Afficher l&#39;OS family et la Distribution</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>  notify {<span class="st">&#39;Utilisation de FACTS&#39;</span>:</span>
<span id="cb50-3"><a href="#cb50-3"></a>    message =&gt; <span class="st">&quot;Famille: ${facts[&#39;os&#39;][&#39;family&#39;]} et Distribution: ${facts[&#39;os&#39;][&#39;distro&#39;][&#39;codename&#39;]} &quot;</span>,</span>
<span id="cb50-4"><a href="#cb50-4"></a>  }</span></code></pre></div>
<h5 id="résultat-3">Résultat:</h5>
<div class="sourceCode" id="cb51"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1"></a><span class="ex">Notice</span>: Famille: Debian et Distribution: buster</span>
<span id="cb51-2"><a href="#cb51-2"></a><span class="ex">Notice</span>: /Stage[main]/Demo_vars/Notify[Utilisation de FACTS]/message: defined <span class="st">&#39;message&#39;</span> as <span class="st">&#39;Famille: Debian et Distribution: buster &#39;</span></span></code></pre></div>
<h1 id="conditionnals-loops">Conditionnals &amp; Loops</h1>
<ul>
<li><p><a href="https://puppet.com/docs/puppet/7/lang_conditional.html" class="uri">https://puppet.com/docs/puppet/7/lang_conditional.html</a></p></li>
<li><p><a href="https://puppet.com/docs/puppet/7/lang_iteration.html" class="uri">https://puppet.com/docs/puppet/7/lang_iteration.html</a></p></li>
</ul>
<h1 id="tp-vars-facts-conditionnals">TP Vars + Facts + conditionnals</h1>
<h4 id="objectifs-1">Objectifs</h4>
<p>Dans ce travail pratique nous allons:</p>
<ul>
<li>écrire un nouveau manifest</li>
<li>Définir une classe</li>
<li>se familiariser avec les variables, les facts et les conditions (instruction de controle)</li>
<li>Utiliser la ressource package pour installer une liste de packages</li>
</ul>
<h4 id="prérequis-1">Prérequis</h4>
<ul>
<li><p>Doc :</p>
<ul>
<li><p><strong>Variables</strong> : https://puppet.com/docs/puppet/7/lang_variables.html</p></li>
<li><p><strong>Facts</strong> : https://puppet.com/docs/puppet/7/lang_facts_accessing.html</p></li>
<li><p><strong>conditions</strong> : https://puppet.com/docs/puppet/7/lang_conditional.html</p></li>
<li><p><strong>relationships</strong> : https://puppet.com/docs/puppet/7/lang_relationships.html</p></li>
</ul></li>
</ul>
<hr />
<h2 id="exercice-1">Exercice 1:</h2>
<div class="question">
Sujet: Créer le manifest <code>manage_package.pp</code> dans <em>code/environments/production/manifests</em>
</div>
<ol type="1">
<li><p>Définir une classe</p></li>
<li><p>Déclarer une variable lst_package qui s’adapte en fonction de l’os</p></li>
</ol>
<ul>
<li>Debian: ntp, apache2</li>
<li>RedHat: chrony, httpd</li>
</ul>
<ol start="3" type="1">
<li>Utiliser cette variable dans une ressource <strong>package</strong> pour faire installer le produit sur les agent</li>
</ol>
<ul>
<li>https://puppet.com/docs/puppet/7/types/package.html</li>
</ul>
<ol start="4" type="1">
<li>Déclarer la classe dans le manifest principal site.pp</li>
</ol>
<h3 id="réalisation">Réalisation</h3>
<h4 id="fichier-manage_packages.pp">Fichier <code>manage_packages.pp</code></h4>
<div class="sourceCode" id="cb52"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># manage_packages.pp</span></span>
<span id="cb52-2"><a href="#cb52-2"></a></span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="kw">class</span> manage_packages {</span>
<span id="cb52-4"><a href="#cb52-4"></a>  </span>
<span id="cb52-5"><a href="#cb52-5"></a>  <span class="co"># 1. Déclarer une variable lst_package qui s&#39;adapte en fonction de l&#39;os</span></span>
<span id="cb52-6"><a href="#cb52-6"></a>  <span class="dt">$lst_package</span> = <span class="dt">$facts</span>[<span class="st">&#39;os&#39;</span>][<span class="st">&#39;family&#39;</span>] ? {</span>
<span id="cb52-7"><a href="#cb52-7"></a>    <span class="st">&#39;Debian&#39;</span> =&gt; [<span class="st">&#39;apache2&#39;</span>, <span class="st">&#39;ntp&#39;</span>],</span>
<span id="cb52-8"><a href="#cb52-8"></a>    <span class="st">&#39;RedHat&#39;</span> =&gt; [<span class="st">&#39;httpd&#39;</span>, <span class="st">&#39;chrony&#39;</span>],</span>
<span id="cb52-9"><a href="#cb52-9"></a>  }</span>
<span id="cb52-10"><a href="#cb52-10"></a>  </span>
<span id="cb52-11"><a href="#cb52-11"></a>  <span class="co"># 2. Utiliser cette variable dans une ressource **package** pour faire installer le produit sur les agent</span></span>
<span id="cb52-12"><a href="#cb52-12"></a>  package {<span class="dt">$lst_package</span>:</span>
<span id="cb52-13"><a href="#cb52-13"></a>    <span class="kw">ensure</span>  =&gt;  installed,</span>
<span id="cb52-14"><a href="#cb52-14"></a>  }</span>
<span id="cb52-15"><a href="#cb52-15"></a></span>
<span id="cb52-16"><a href="#cb52-16"></a></span>
<span id="cb52-17"><a href="#cb52-17"></a>} <span class="co"># End of Class</span></span></code></pre></div>
<h4 id="fichier-site.pp">Fichier <code>site.pp</code></h4>
<div class="sourceCode" id="cb53"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb53-1"><a href="#cb53-1"></a><span class="co"># site.pp</span></span>
<span id="cb53-2"><a href="#cb53-2"></a></span>
<span id="cb53-3"><a href="#cb53-3"></a><span class="co"># Manifest applied to &#39;cli03.formation.lan&#39;</span></span>
<span id="cb53-4"><a href="#cb53-4"></a>node <span class="st">&#39;cli03.formation.lan&#39;</span> {</span>
<span id="cb53-5"><a href="#cb53-5"></a>  include ::manage_user</span>
<span id="cb53-6"><a href="#cb53-6"></a>  include ::manage_ssh</span>
<span id="cb53-7"><a href="#cb53-7"></a>  include ::demo_vars</span>
<span id="cb53-8"><a href="#cb53-8"></a>  include ::demo_condition</span>
<span id="cb53-9"><a href="#cb53-9"></a>  include ::manage_packages</span>
<span id="cb53-10"><a href="#cb53-10"></a>}</span>
<span id="cb53-11"><a href="#cb53-11"></a></span>
<span id="cb53-12"><a href="#cb53-12"></a><span class="co"># Manifest applied by default for nodes not-declared above</span></span>
<span id="cb53-13"><a href="#cb53-13"></a>node default {</span>
<span id="cb53-14"><a href="#cb53-14"></a>  include ::manage_user</span>
<span id="cb53-15"><a href="#cb53-15"></a>  include ::manage_packages</span>
<span id="cb53-16"><a href="#cb53-16"></a>}</span></code></pre></div>
<h4 id="résultat-4">Résultat</h4>
<p><img src="2021-07-21-POEI-Puppet/2021-07-23_10h28_28.png" /></p>
<h1 id="tp-classe-paramétrable">TP Classe paramétrable</h1>
<h4 id="objectifs-2">Objectifs</h4>
<p>Dans ce travail pratique nous allons:</p>
<ul>
<li>écrire un nouveau manifest</li>
<li>Définir une classe paramétrable</li>
<li>se familiariser avec les variables</li>
<li>Utiliser de nouvelles ressources : exec</li>
<li>Gérer l’idempotence</li>
</ul>
<h4 id="prérequis-2">Prérequis</h4>
<ul>
<li><p>Doc :</p>
<ul>
<li><p><strong>Variables</strong> : https://puppet.com/docs/puppet/7/lang_variables.html</p></li>
<li><p><strong>exec</strong> : https://puppet.com/docs/puppet/7/types/exec.html</p></li>
</ul></li>
</ul>
<hr />
<h2 id="exercice-1-créer-le-manifest-manage_tz.pp-dans-codeenvironmentsproductionmanifests">Exercice 1 : Créer le manifest <code>manage_tz.pp</code> dans <em>code/environments/production/manifests</em></h2>
<ol type="1">
<li>Définir une classe manage_tz paramétrable :</li>
</ol>
<ul>
<li>variable type string $timezone avec valeur par défaut : ‘Europe/Paris’</li>
</ul>
<ol start="2" type="1">
<li>Déclarer une ressource exec qui met à jour la timezone et utilise la variable $timezone</li>
</ol>
<ul>
<li>commande : timedatectl set-timezone ${timezone}</li>
</ul>
<ol start="3" type="1">
<li><p>Déclarer la classe dans le fichier manifest site.pp (uniquement pour cli03 - systemd)</p></li>
<li><p>Analyse le comportement (idempotence) lors du redéclenchement de l’agent</p></li>
<li><p>Essayer de mieux gérer l’idempotence dans la ressource exec</p></li>
</ol>
<h2 id="exercice-2-un-nouveau-projet-demande-lintégration-dun-node-anglophone">Exercice 2 : Un nouveau projet demande l’intégration d’un node anglophone</h2>
<ol start="7" type="1">
<li>Créer un nouveau cli04.formation.lan depuis la vm puppetmaster et l’ingétrer en tant qu’agent</li>
</ol>
<div class="sourceCode" id="cb54"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1"></a>$ <span class="ex">docker</span> run -d --name cli04.formation.lan --hostname cli04.formation.lan --tmpfs /tmp --tmpfs /run --tmpfs /run/lock -v /sys/fs/cgroup:/sys/fs/cgroup:ro --add-host=<span class="st">&quot;puppet:172.16.8.11&quot;</span> bilbloke/puppet-systemd:1.0</span></code></pre></div>
<ol start="8" type="1">
<li>Dans site.pp, déclare la classe manage_tz avec une valeur de parametre différent pour le node cli04</li>
</ol>
<ul>
<li>$timezone = ‘Europe/London’</li>
</ul>
<ol start="9" type="1">
<li>Tester</li>
</ol>
<h2 id="soluces">Soluces</h2>
<h4 id="manage_tz.pp">manage_tz.pp</h4>
<p>Dans le fichier <code>manage_tz.pp</code></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb55-1"><a href="#cb55-1"></a><span class="co"># Fichier: manage_tz.pp</span></span>
<span id="cb55-2"><a href="#cb55-2"></a><span class="co"># ---------------------</span></span>
<span id="cb55-3"><a href="#cb55-3"></a></span>
<span id="cb55-4"><a href="#cb55-4"></a><span class="co"># classe de management de la timezone</span></span>
<span id="cb55-5"><a href="#cb55-5"></a><span class="kw">class</span> manage_tz ( <span class="dt">String</span> <span class="dt">$timezone</span> = <span class="st">&#39;Europe/Paris&#39;</span> ) {</span>
<span id="cb55-6"><a href="#cb55-6"></a></span>
<span id="cb55-7"><a href="#cb55-7"></a>  exec { <span class="st">&#39;Mise à jour timezone&#39;</span>:</span>
<span id="cb55-8"><a href="#cb55-8"></a>    path    =&gt; [ <span class="st">&#39;/usr/bin&#39;</span>, <span class="st">&#39;/usr/sbin&#39;</span>, <span class="st">&#39;/bin&#39;</span>],              <span class="co"># le path du binaire pour être sûr qu&#39;il se déclenche</span></span>
<span id="cb55-9"><a href="#cb55-9"></a>    command =&gt; <span class="st">&quot;timedatectl set-timezone ${timezone}&quot;</span>,</span>
<span id="cb55-10"><a href="#cb55-10"></a>    onlyif  =&gt; <span class="st">&quot;timedatectl | grep Time | grep -v ${timezone}&quot;</span>  <span class="co"># idempotence</span></span>
<span id="cb55-11"><a href="#cb55-11"></a>  }</span>
<span id="cb55-12"><a href="#cb55-12"></a></span>
<span id="cb55-13"><a href="#cb55-13"></a>}</span></code></pre></div>
<div class="warning">
<p>Attention à l’<strong>idempotence</strong> !!!</p>
Autrement la commande <strong>exec</strong> se relancera à chaque fois même si cela ne produit pas de changements.
</div>
<h4 id="site.pp">site.pp</h4>
<p>Dans le fichier <code>site.pp</code> :</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb56-1"><a href="#cb56-1"></a><span class="co"># Manifest applied to &#39;cli03.formation.lan&#39;</span></span>
<span id="cb56-2"><a href="#cb56-2"></a>node <span class="st">&#39;cli03.formation.lan&#39;</span> {</span>
<span id="cb56-3"><a href="#cb56-3"></a>  include ::manage_tz</span>
<span id="cb56-4"><a href="#cb56-4"></a>}</span>
<span id="cb56-5"><a href="#cb56-5"></a></span>
<span id="cb56-6"><a href="#cb56-6"></a>node cli04.formation.lan {</span>
<span id="cb56-7"><a href="#cb56-7"></a>  <span class="kw">class</span> { <span class="st">&#39;::manage_tz&#39;</span>:</span>
<span id="cb56-8"><a href="#cb56-8"></a>    timezone =&gt; <span class="st">&#39;Europe/London&#39;</span>, <span class="co"># Force la variable timezone pour le client 04</span></span>
<span id="cb56-9"><a href="#cb56-9"></a>  }</span>
<span id="cb56-10"><a href="#cb56-10"></a>}</span>
<span id="cb56-11"><a href="#cb56-11"></a></span>
<span id="cb56-12"><a href="#cb56-12"></a><span class="co"># Manifest applied by default for nodes not-declared above</span></span>
<span id="cb56-13"><a href="#cb56-13"></a>node default {</span>
<span id="cb56-14"><a href="#cb56-14"></a>  include ::manage_user</span>
<span id="cb56-15"><a href="#cb56-15"></a>  include ::manage_packages</span>
<span id="cb56-16"><a href="#cb56-16"></a>}</span></code></pre></div>
<h4 id="résultat-5">Résultat</h4>
<h5 id="application-du-manifest">Application du <em>manifest</em></h5>
<div class="sourceCode" id="cb57"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1"></a><span class="co"># Application du manifest</span></span>
<span id="cb57-2"><a href="#cb57-2"></a><span class="ex">root@cli04</span>:/# puppet agent -t</span>
<span id="cb57-3"><a href="#cb57-3"></a><span class="ex">Info</span>: Using configured environment <span class="st">&#39;production&#39;</span></span>
<span id="cb57-4"><a href="#cb57-4"></a><span class="ex">Info</span>: Retrieving pluginfacts</span>
<span id="cb57-5"><a href="#cb57-5"></a><span class="ex">Info</span>: Retrieving plugin</span>
<span id="cb57-6"><a href="#cb57-6"></a><span class="ex">Info</span>: Caching catalog for cli04.formation.lan</span>
<span id="cb57-7"><a href="#cb57-7"></a><span class="ex">Info</span>: Applying configuration version <span class="st">&#39;1627034859&#39;</span></span>
<span id="cb57-8"><a href="#cb57-8"></a><span class="ex">Notice</span>: /Stage[main]/Manage_tz/Exec[Mise à jour timezone]/returns: executed successfully <span class="co"># Changement OK</span></span>
<span id="cb57-9"><a href="#cb57-9"></a><span class="ex">Notice</span>: Applied catalog in 0.17 seconds</span></code></pre></div>
<h5 id="vérification-de-lidempotence">Vérification de l’<strong>idempotence</strong></h5>
<div class="sourceCode" id="cb58"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1"></a><span class="co"># Vérification de l&#39;idempotence</span></span>
<span id="cb58-2"><a href="#cb58-2"></a><span class="ex">root@cli04</span>:/# puppet agent -t</span>
<span id="cb58-3"><a href="#cb58-3"></a><span class="ex">Info</span>: Using configured environment <span class="st">&#39;production&#39;</span></span>
<span id="cb58-4"><a href="#cb58-4"></a><span class="ex">Info</span>: Retrieving pluginfacts</span>
<span id="cb58-5"><a href="#cb58-5"></a><span class="ex">Info</span>: Retrieving plugin</span>
<span id="cb58-6"><a href="#cb58-6"></a><span class="ex">Info</span>: Caching catalog for cli04.formation.lan</span>
<span id="cb58-7"><a href="#cb58-7"></a><span class="ex">Info</span>: Applying configuration version <span class="st">&#39;1627035620&#39;</span></span>
<span id="cb58-8"><a href="#cb58-8"></a><span class="ex">Notice</span>: Applied catalog in 0.09 seconds</span></code></pre></div>
<h5 id="vérification-de-la-timezone">Vérification de la Timezone</h5>
<div class="sourceCode" id="cb59"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb59-1"><a href="#cb59-1"></a><span class="ex">root@cli04</span>:/# timedatectl</span>
<span id="cb59-2"><a href="#cb59-2"></a>               <span class="ex">Local</span> time: Fri 2021-07-23 11:22:48 BST</span>
<span id="cb59-3"><a href="#cb59-3"></a>           <span class="ex">Universal</span> time: Fri 2021-07-23 10:22:48 UTC</span>
<span id="cb59-4"><a href="#cb59-4"></a>                 <span class="ex">RTC</span> time: n/a</span>
<span id="cb59-5"><a href="#cb59-5"></a>                <span class="ex">Time</span> zone: Europe/London (BST, +0100)</span>
<span id="cb59-6"><a href="#cb59-6"></a><span class="ex">System</span> clock synchronized: yes</span>
<span id="cb59-7"><a href="#cb59-7"></a>              <span class="ex">NTP</span> service: inactive</span>
<span id="cb59-8"><a href="#cb59-8"></a>          <span class="ex">RTC</span> in local TZ: no</span></code></pre></div>
<h1 id="modules-puppet">Modules Puppet</h1>
<ul>
<li>classe bien rangées</li>
<li>Serveur de fichiers (classer les fichiers statics, templates)</li>
<li>Arborescence à respecter</li>
<li>Outil fourni par puppet : PDK
<ul>
<li><a href="https://puppet.com/try-puppet/puppet-development-kit/" class="uri">https://puppet.com/try-puppet/puppet-development-kit/</a></li>
<li><a href="https://puppet.com/docs/pdk/2.x/pdk_creating_modules.html" class="uri">https://puppet.com/docs/pdk/2.x/pdk_creating_modules.html</a></li>
</ul></li>
<li>Forge puppet : catalogue de module déjà codé et donc téléchargeables et utilisables
<ul>
<li><a href="https://forge.puppet.com/" class="uri">https://forge.puppet.com/</a></li>
</ul></li>
</ul>
<h2 id="création-du-module-en-ligne-de-commande">Création du module en ligne de commande :</h2>
<div class="sourceCode" id="cb60"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb60-1"><a href="#cb60-1"></a>$ <span class="ex">pdk</span> new module bootstrap /etc/puppetlabs/code/environments/production/modules/bootstrap</span></code></pre></div>
<h3 id="arborescence-du-module">Arborescence du module</h3>
<div class="sourceCode" id="cb61"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb61-1"><a href="#cb61-1"></a><span class="ex">root@ppmaster</span>:/etc/puppetlabs/code/environments/production# tree modules/</span>
<span id="cb61-2"><a href="#cb61-2"></a><span class="ex">modules/</span></span>
<span id="cb61-3"><a href="#cb61-3"></a>└── <span class="ex">bootstrap</span></span>
<span id="cb61-4"><a href="#cb61-4"></a>    ├── <span class="ex">CHANGELOG.md</span></span>
<span id="cb61-5"><a href="#cb61-5"></a>    ├── <span class="ex">Gemfile</span></span>
<span id="cb61-6"><a href="#cb61-6"></a>    ├── <span class="ex">Gemfile.lock</span></span>
<span id="cb61-7"><a href="#cb61-7"></a>    ├── <span class="ex">README.md</span></span>
<span id="cb61-8"><a href="#cb61-8"></a>    ├── <span class="ex">Rakefile</span></span>
<span id="cb61-9"><a href="#cb61-9"></a>    ├── <span class="ex">appveyor.yml</span></span>
<span id="cb61-10"><a href="#cb61-10"></a>    ├── <span class="ex">data</span></span>
<span id="cb61-11"><a href="#cb61-11"></a>    │   └── <span class="ex">common.yaml</span></span>
<span id="cb61-12"><a href="#cb61-12"></a>    ├── <span class="ex">examples</span></span>
<span id="cb61-13"><a href="#cb61-13"></a>    ├── <span class="ex">files</span></span>
<span id="cb61-14"><a href="#cb61-14"></a>    ├── <span class="ex">hiera.yaml</span></span>
<span id="cb61-15"><a href="#cb61-15"></a>    ├── <span class="ex">manifests</span></span>
<span id="cb61-16"><a href="#cb61-16"></a>    ├── <span class="ex">metadata.json</span></span>
<span id="cb61-17"><a href="#cb61-17"></a>    ├── <span class="ex">spec</span></span>
<span id="cb61-18"><a href="#cb61-18"></a>    │   ├── <span class="ex">default_facts.yml</span></span>
<span id="cb61-19"><a href="#cb61-19"></a>    │   └── <span class="ex">spec_helper.rb</span></span>
<span id="cb61-20"><a href="#cb61-20"></a>    ├── <span class="ex">tasks</span></span>
<span id="cb61-21"><a href="#cb61-21"></a>    └── <span class="ex">templates</span></span></code></pre></div>
<hr />
<h1 id="tips-tricks">Tips &amp; Tricks</h1>
<ul>
<li><a href="#certificats-puppet">Certificats Puppet</a></li>
<li><a href="#astuce-environnement-de-code">Astuce Environnement de Code sur Vusial Studio</a></li>
<li><a href="#noop">Option noop</a></li>
</ul>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<hr />
<h5 id="the-end" align="center">The End</h5>
<hr />

<div class="footer" id="bottom">
  <p> *** <a href="#top">Top / Début</a> - <a href="Index_des_Documentations.html">Index des Documentations</a> - <a href="#the-end">Bottom / Fin</a> *** </p>
</div>
</body>
</html>
